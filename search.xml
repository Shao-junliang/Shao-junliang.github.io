<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>指针与函数</title>
      <link href="/2024/08/12/c-basic-ptr/"/>
      <url>/2024/08/12/c-basic-ptr/</url>
      
        <content type="html"><![CDATA[<h3 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h3><p> <strong>指针</strong>是一个变量，其值为另一个变量的地址。</p><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>指针定义时尽量同时进行初始化，因为未初始化的指针容易出错；</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token operator">*</span>ptrErr <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 错误示例，没有赋初值</span><span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token keyword">nullptr</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">*</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">;</span> <span class="token comment">// 声明创建了一个指针*p1与int变量p2，对每个指针变量，都需要一个'*';</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="指针的具体使用"><a href="#指针的具体使用" class="headerlink" title="指针的具体使用"></a>指针的具体使用</h4><ul><li>使用指针。<code>&amp;</code> 可以应用在任何类型的变量上面，然后用变量对应的指针类型去存储变量的地址。间接运算符 <code>*</code> 可以获取内存地址所存储的对应的变量值，通常也称它为解引用运算符。当它和类型放在一起，例如 <code>int*</code>，便是声明指针的；当它和变量放在一起(前面没有加类型或者 auto)，例如 <code>*p_value</code>，便是解引用的。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token operator">*</span>ptr2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加了括号是将 'int' 初始化为 0;</span><span class="token keyword">int</span> <span class="token operator">*</span>ptr3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">;</span>   <span class="token comment">// 未初始化的 int 可能会包含一个未定义的值</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ptr2 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 0</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ptr3 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 0，编译器或运行环境可能会在调试模式下或出于安全考虑将动态分配的内存初始化为 0</span><span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">*</span>ptr1 <span class="token operator">=</span> <span class="token operator">&amp;</span>value<span class="token punctuation">;</span>    <span class="token comment">// 地址运算符 "&amp;" 可以获取变量的内存地址，常用于指针变量的初始化。</span>ptr2 <span class="token operator">=</span> ptr1<span class="token punctuation">;</span>           <span class="token comment">// 将value的地址传给了 ptr2，此时ptr1与ptr2都指向value的地址</span><span class="token operator">*</span>ptr2 <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>            <span class="token comment">// ptr2 修改了value的值，*ptr1 = 60</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>指针的算术运算：本质是让指针沿着一定的方向去移动指定大小（整数 * 指针所指向的类型大小）的单位。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">float</span> <span class="token operator">*</span>ptr_f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// ptr_f 指向数组的首地址</span>ptr_f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>ptr_f<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span><span class="token comment">// ptr_f + 1 在内存上沿着一定的方向移动指定大小：(1 * sizeof(float)) 的偏移量，</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr_f <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>特别注意：指向数值类型的指针必须解引用，才能拿到指针所指向的元素值。但是指向 char 类型的指针，可以不经过解引用，直接利用指针名获得元素的值。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>c_ptr <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"LSJune"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> char_ptr <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        <span class="token comment">// LSJune</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>char_ptr <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>       <span class="token comment">// L</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> char_ptr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>     <span class="token comment">// S</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span><span class="token punctuation">(</span>char_ptr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// S</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="指针与数组"><a href="#指针与数组" class="headerlink" title="指针与数组"></a>指针与数组</h4><ul><li>指针指向数组： 数组里面存的是变量，指针指向的是数组中的第一个元素。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">float</span> <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 分配数组，并将首地址存储在 f 中</span>f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2.0f</span><span class="token punctuation">;</span>f<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4.0f</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>f <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>    <span class="token comment">// 0x7ffdc5cea698</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> f <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>     <span class="token comment">// 0x18bae70</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> f <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 0x18bae74</span><span class="token comment">// 指针变量当数组来用</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 2</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> f<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 4</span><span class="token comment">// 对数组指针解引用</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>f <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>       <span class="token comment">// 2</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span><span class="token punctuation">(</span>f <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 4</span><span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> f<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>指针数组：数组里面存的是变量的指针，这个变量可以是数组，也可以是变量。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">float</span> <span class="token operator">*</span>fs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>fs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 变量是数组</span>fs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 变量是数值</span>fs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3.0f</span><span class="token punctuation">;</span><span class="token operator">*</span>fs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4.0f</span><span class="token punctuation">;</span>fs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5.0f</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> fs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 3</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>fs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>   <span class="token comment">// 4</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> fs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 5</span><span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">delete</span> fs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="指针与const"><a href="#指针与const" class="headerlink" title="指针与const"></a>指针与const</h4><ul><li>指向常量的指针：指针是变量（指向的地址可以变），指向的值是常量（常量值不可以修改）。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>value<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ptr <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 10</span>ptr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">&#123;</span><span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// 修改了指针指向的地址，但是不可以 *ptr = 20;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ptr <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>常量指针：存储的值为变量（存储的值可以修改），指针为常量（指向的地址不能变）。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> key <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p_key <span class="token operator">=</span> <span class="token operator">&amp;</span>key<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> p_key <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>  <span class="token comment">// 0x7fffdc0aa754</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p_key <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 10</span>key <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> p_key <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>  <span class="token comment">// 0x7fffdc0aa754</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p_key <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>指向常量的常量指针：指针为常量，存储的值也为常量，指针地址与常量的值都不可以修改。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> data <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p_data <span class="token operator">=</span> <span class="token operator">&amp;</span>data<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> p_data <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>  <span class="token comment">// 0x7ffc0a7e47a4</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p_data <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><ul><li><p>引用变量是一个别名，相当于是某个已存在变量的另一个名字。</p></li><li><p>引用与指针的区别:</p><ol><li>引用在创建时必须被初始化；指针可以在任何时间被初始化。</li><li>引用一旦被初始化，就不能再指向到另一个对象。指针可以在任何时候指向到另一个对象。</li><li>指针定义：类型名+’*’；引用定义：类型名+’&amp;’。</li></ol></li><li><p>引用与函数：</p><ol><li><code>function(int param)</code>：按值传参，实际上传入的是原始变量的一个副本，修改参数不会修改原始变量的值。</li><li><code>function(int &amp;param)</code>：引用传参，实际上传入的是指向原始变量的一个指针，修改引用会修改原始变量的值，但是不会产生变量复制。</li><li><code>function(const int &amp;param)</code>：const 引用传参，向函数传入的是指向原始变量的一个指针，该指针是const类型，既可避免原始变量复制，同时又不会改变原始参数的值。</li></ol></li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>value<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>ref <span class="token operator">=</span> value<span class="token punctuation">;</span><span class="token operator">*</span>ptr <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"data of value: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ptr <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>    <span class="token comment">// 20</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"data of value: "</span> <span class="token operator">&lt;&lt;</span> ref <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>     <span class="token comment">// 20</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"address of value: "</span> <span class="token operator">&lt;&lt;</span> ptr <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>  <span class="token comment">// 0x7ffcd9b4ea9c</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"address of value: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>ref <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 0x7ffcd9b4ea9c</span>ref <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"data of value: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>ptr <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>    <span class="token comment">// 30</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"data of value: "</span> <span class="token operator">&lt;&lt;</span> ref <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>     <span class="token comment">// 30</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"address of value: "</span> <span class="token operator">&lt;&lt;</span> ptr <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>  <span class="token comment">// 0x7ffcd9b4ea9c</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"address of value: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>ref <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 0x7ffcd9b4ea9c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意：引用传参不能传表达式。如：</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">refcube</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> temp<span class="token punctuation">;</span>    temp <span class="token operator">=</span> a<span class="token punctuation">;</span>    a <span class="token operator">=</span> b<span class="token punctuation">;</span>    b <span class="token operator">=</span> temp<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>    <span class="token function">refcube</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 报错：cannot bind non-const lvalue reference of type ‘int&amp;’ to an rvalue of type ‘int’</span>    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="左值引用"><a href="#左值引用" class="headerlink" title="左值引用"></a>左值引用</h4><h4 id="右值引用"><a href="#右值引用" class="headerlink" title="右值引用"></a>右值引用</h4><h3 id="函数指针"><a href="#函数指针" class="headerlink" title="函数指针"></a>函数指针</h3><p>与数据项相似，函数也有地址。函数的地址是存储其机器语言代码的内存的开始地址。</p><h4 id="初始化与调用"><a href="#初始化与调用" class="headerlink" title="初始化与调用"></a>初始化与调用</h4><p>要再 <code>postProcess()</code> 函数里面调用 <code>NMS()</code> 函数，通常需要完成下面的工作：</p><ol><li>获取函数的地址：使用函数名（后面不跟参数）即可获取函数地址；</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">postProcess</span><span class="token punctuation">(</span>NMS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将NMS函数传入postProcess，使得postProcess可以在内部调用NMS函数</span><span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token function">NMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 首先执行NMS()函数，然后将NMS()函数的返回值当作参数传给postProcess函数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>声明函数指针：声明指向函数的指针时，必须指定指针指向的函数类型（函数的返回类型以及参数列表）。</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">NMS</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 函数原型</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>nms<span class="token punctuation">)</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 声明函数指针，只需用 `(*函数指针名)` 要替换函数名即可</span><span class="token comment">// void *nms(std::vector&lt;int>); 返回值为指针的函数，函数名为 nms，并非函数指针。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>通常，要声明指向特定类型的函数的指针，可以首先编写这种函数的原型，然后用（*pf）替换函数名。这样pf就是这类函数的指针。</p><ol start="3"><li>函数指针初始化</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">NMS</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 函数原型</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>nms<span class="token punctuation">)</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>NMS<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 用函数名初始化函数指针</span><span class="token keyword">auto</span> nms <span class="token operator">=</span> NMS<span class="token punctuation">;</span><span class="token comment">// 用关键字 auto 初始化函数指针</span><span class="token keyword">auto</span> <span class="token operator">*</span>nms <span class="token operator">=</span> NMS<span class="token punctuation">;</span><span class="token comment">// 显式初始化，代码可读性更强</span><span class="token keyword">auto</span> <span class="token operator">*</span>nms <span class="token operator">=</span> <span class="token operator">&amp;</span>NMS<span class="token punctuation">;</span><span class="token comment">// 用地址运算符 &amp; 初始化函数指针</span><span class="token keyword">auto</span> nms <span class="token operator">=</span> <span class="token operator">&amp;</span>NMS<span class="token punctuation">;</span><span class="token comment">// 显式初始化，代码可读性更强</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>函数指针调用函数</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>nms<span class="token punctuation">)</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>NMS<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 函数指针初始化</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token function">NMS</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 函数原型调用</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token function">nms</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 函数指针隐式调用</span><span class="token keyword">int</span> z <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>nms<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 函数指针显式调用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="函数指针数组"><a href="#函数指针数组" class="headerlink" title="函数指针数组"></a>函数指针数组</h4><p>假设现在声明了三个函数原型：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">double</span> ar<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> <span class="token function">f3</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这几个函数的参数看似不同，但实际上相同；将其初始化为函数指针数组：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>pf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>f1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 指针调用</span><span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> px <span class="token operator">=</span> <span class="token operator">*</span>pf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 隐式调用</span><span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> py <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 显式调用</span><span class="token comment">// 解引用，获得指向double的值</span><span class="token keyword">double</span> x <span class="token operator">=</span> <span class="token operator">*</span>pf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 隐式调用</span><span class="token keyword">double</span> y <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>pf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 显式调用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运算符<code>[]</code>的优先级高于 <code>*</code>，因此 <code>*pf[3]</code> 表明 <code>pf</code> 是一个包含三个指针的数组。<strong>此处不能使用auto，自动类型推断只能用于单值初始化，而不能用于初始化列表</strong></p><p>如何显示的声明指向 <code>pf</code> 数组的指针：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 'const double *' 返回值类型，</span><span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>p_pf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>pf<span class="token punctuation">;</span><span class="token comment">// 运算符 [] 与 () 同级。</span><span class="token keyword">auto</span> p_pf <span class="token operator">=</span> <span class="token operator">&amp;</span>pf<span class="token punctuation">;</span> <span class="token comment">// 这样也可以</span><span class="token comment">// 指针调用</span><span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> px <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>p_pf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 隐式调用</span><span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> py <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>p_pf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 显式调用</span><span class="token comment">// 解引用，获得指向double的值</span><span class="token keyword">double</span> x <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>p_pf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 隐式调用</span><span class="token keyword">double</span> y <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>p_pf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 显式调用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>数组 <code>pf</code> 与 <code>&amp;pf</code> 之间的区别：<ol><li><code>pf</code> 表示数组第一个元素的地址，但 <code>&amp;pf</code> 表示整个数组（三个指针块的地址），即：<code>pf=&amp;pf[0]</code>。 </li><li>数值上来讲，<code>pf</code> 与 <code>&amp;pf</code> 值相同，但是他们的类型不同，<code>pf+1</code> 为数组中的下一个元素，<code>&amp;pf+1</code> 为数组 <code>pf</code> 后面一个12字节(假设 <code>pf</code> 数组大小为12字节，每个元素4字节，三个元素)内存块的地址。</li><li>解引用次数不同。要得到第一个元素的值，<code>pf</code> 需要解引用一次，但 <code>&amp;pf</code> 需要解引用两次：<code>*pf == **&amp;pf == pf[0]</code></li></ol></li></ul><h4 id="typedef、using简化"><a href="#typedef、using简化" class="headerlink" title="typedef、using简化"></a>typedef、using简化</h4><p>利用 <code>typedef</code> 或者 <code>using</code> 关键字创建类型别名：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>p_f<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// p_f 是一个类型别名</span><span class="token keyword">using</span> p_f <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token keyword">double</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">double</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 使用using创建类型别名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>使用类型别名简化代码</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">p_f pf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>f1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 函数指针数组</span><span class="token function">p_f</span> <span class="token punctuation">(</span><span class="token operator">*</span>p_pf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>pf<span class="token punctuation">;</span><span class="token comment">// 函数指针数组的指针</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="函数模板"><a href="#函数模板" class="headerlink" title="函数模板"></a>函数模板</h3><h4 id="模板概念与定义"><a href="#模板概念与定义" class="headerlink" title="模板概念与定义"></a>模板概念与定义</h4><p>函数模板是通用的函数描述，它们使用泛型来定义函数，其中的泛型可用具体的类型（如 int 或 double）替换。模板的定义以关键字 <code>template</code> 开始，后跟一个由尖括号 <code>&lt;&gt;</code> 括起来的模板参数列表。定义模板参数的关键字 <code>typename</code> </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token comment">// template &lt;class T></span><span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span>T t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// code</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>基于函数模板生成的函数定义被称为模板的一个实例。 </p><h4 id="模板实例化与具体化"><a href="#模板实例化与具体化" class="headerlink" title="模板实例化与具体化"></a>模板实例化与具体化</h4><p>编译器使用模板为特定类型生成函数定义时，得到的是模板实例(instantiation)。模板并非函数定义，但使用 int 的模板实例是函数定义。这种实例化方式被称为<strong>隐式实例化</strong>。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token comment">// template &lt;class T></span>T <span class="token function">add</span><span class="token punctuation">(</span>T t1<span class="token punctuation">,</span> T t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">template</span> <span class="token keyword">float</span> <span class="token generic-function"><span class="token function">add</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 显式实例化声明和定义合并</span><span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> tmp1 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 隐式实例化</span><span class="token keyword">double</span> tmp2 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2.3</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">add</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">2.2</span><span class="token punctuation">,</span> <span class="token number">3.3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">// 显式实例化</span>    <span class="token keyword">float</span> f1 <span class="token operator">=</span> <span class="token number">2.1f</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> f2 <span class="token operator">=</span> <span class="token number">2.2f</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2.2</span><span class="token punctuation">,</span> <span class="token number">3.3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 也是显式实例化调用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>显式具体化</strong>的原型和定义应以 <code>template &lt;&gt;</code> 打头，并通过名称来指出类型。空的尖括号 <code>&lt;&gt;</code> 表示编译器不需要做类型推导。函数模板具体化的定义必须放在函数模板的声明和定义之后。函数模板具体化的定义需要传递具体的参数类型。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token comment">// template &lt;class T></span>T <span class="token function">add</span><span class="token punctuation">(</span>T t1<span class="token punctuation">,</span> T t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// template &lt;> double add&lt;double>(double t1, double t2);// 声明1</span><span class="token comment">// template &lt;> double add(double t1, double t2);   // 与声明1等价</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token operator">></span> <span class="token keyword">double</span> <span class="token generic-function"><span class="token function">add</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">double</span> t1<span class="token punctuation">,</span> <span class="token keyword">double</span> t2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>cout<span class="token operator">&lt;&lt;</span> <span class="token string">"double"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token keyword">return</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> tmp1 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">double</span> tmp2 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2.3</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 显式具体化</span><span class="token keyword">float</span> f1 <span class="token operator">=</span> <span class="token number">2.1f</span><span class="token punctuation">;</span><span class="token keyword">float</span> f2 <span class="token operator">=</span> <span class="token number">2.3f</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">add</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>f1<span class="token punctuation">,</span>f2<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token keyword">double</span> d1 <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>    <span class="token keyword">double</span> d2 <span class="token operator">=</span> <span class="token number">3.0</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">add</span><span class="token punctuation">(</span>d1<span class="token punctuation">,</span>d2<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token comment">// 显式具体化</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>调用优先顺序：非模板函数 &gt; 具体化模板函数 &gt; 原始模板函数 。</strong></p><h4 id="模板参数"><a href="#模板参数" class="headerlink" title="模板参数"></a>模板参数</h4><p>模板参数分两种：<strong>类型模板参数、非类型模板参数</strong>。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">int</span> N<span class="token operator">></span>T <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">T</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>array<span class="token punctuation">)</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 传参为任意数据类型任意大小的数组。</span>    <span class="token comment">// code</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>其中 <code>typename T</code> 为类型模板参数，经过实例化会变成具体类型。<code>int N</code> 为非类型模板参数，经过实例化会变成具体的值。 </p><p>当模板参数列表中，同时有类型模板参数和非类型模板参数时，建议将非类型模板参数写在类型模板参数的前面。</p><p><strong>指定类型的模板参数</strong>，可以用具体的数据类型为模板参数指定默认值。 </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T1</span><span class="token operator">=</span><span class="token keyword">float</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">T2</span><span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>T1 t1<span class="token punctuation">,</span> T2 t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// code</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="引用传参"><a href="#引用传参" class="headerlink" title="引用传参"></a>引用传参</h4><ul><li>按值传参。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span> T <span class="token function">add</span><span class="token punctuation">(</span>T t1<span class="token punctuation">,</span> T t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> t1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">double</span> t2 <span class="token operator">=</span> <span class="token number">3.6</span><span class="token punctuation">;</span>    <span class="token keyword">int</span><span class="token operator">&amp;</span> t3 <span class="token operator">=</span> t1<span class="token punctuation">;</span>     <span class="token keyword">double</span><span class="token operator">&amp;</span> t4 <span class="token operator">=</span> t2    cout <span class="token operator">&lt;&lt;</span> <span class="token function">add</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> t1<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token function">add</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> t3<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">// 引用类型在模板推导时会被看作它所引用的类型，即 int。</span>    <span class="token comment">// cout &lt;&lt; add(t1, t2) &lt;&lt; endl; 报错，因为模板要求两个参数类型相同，如果要传入不同类型的参数，需要用显式实例化，进行类型强转</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">add</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> t2<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">// cout &lt;&lt; add(t1, t4) &lt;&lt; endl;// 报错，因为第二个形参的类型为 double&amp;，不能指向 int 变量 t1。</span>cout <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">add</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> t4<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 类型强转了</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>引用传参</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">></span> T <span class="token function">add</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>t1<span class="token punctuation">,</span> T<span class="token operator">&amp;</span> t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token operator">></span> <span class="token keyword">double</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token operator">&amp;</span> d1 <span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">&amp;</span> d2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> d1 <span class="token operator">+</span> d2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> t1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">double</span> t2 <span class="token operator">=</span> <span class="token number">3.6</span><span class="token punctuation">;</span>    <span class="token comment">// 报错：因为第一个形参的类型为 double&amp;，不能指向 int 变量 t1</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">add</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span>t2<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="返回类型"><a href="#返回类型" class="headerlink" title="返回类型"></a>返回类型</h4><p>当传入的参数类型不同，存在强制转化时，如何确定变量类型？如下例：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T1</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">T2</span><span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>T<span class="token operator">&amp;</span> t1<span class="token punctuation">,</span> T<span class="token operator">&amp;</span> t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    type t <span class="token operator">=</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span><span class="token comment">// t 应该是什么类型，如 T1 为 int 类型，T2 为 double 类型</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>利用关键字 <code>decltype</code> 确定变量类型。<code>decltype</code> 可以传入表达式，如：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T1</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">T2</span><span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>t1<span class="token punctuation">,</span> T<span class="token operator">&amp;</span> t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">decltype</span><span class="token punctuation">(</span>t1 <span class="token operator">+</span> t2<span class="token punctuation">)</span> t <span class="token operator">=</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>但是，如果函数需要添加返回类型时，又该如何定义，如下例：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T1</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">T2</span><span class="token operator">></span> type <span class="token function">add</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>t1<span class="token punctuation">,</span> T<span class="token operator">&amp;</span> t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">decltype</span><span class="token punctuation">(</span>t1 <span class="token operator">+</span> t2<span class="token punctuation">)</span> t <span class="token operator">=</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span>    <span class="token keyword">return</span> t<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不可以直接用 <code>decltype(t1 + t2)</code> 作为返回类型，因为此时还未声明参数 <code>t1</code> 与 <code>t2</code>，它们不在作用域内，必须在声明参数后使用 <code>decltype</code>。此时可以利用关键字 <code>auto</code> 去推断返回值类型。如：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T1</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">T2</span><span class="token operator">></span> <span class="token keyword">auto</span> <span class="token function">add</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>t1<span class="token punctuation">,</span> T<span class="token operator">&amp;</span> t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">decltype</span><span class="token punctuation">(</span>t1 <span class="token operator">+</span> t2<span class="token punctuation">)</span> t <span class="token operator">=</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span>    <span class="token keyword">return</span> t<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是，使用auto来推导函数的返回值类型时，会默认去掉引用和 <code>const</code> 限定符，因此，以上方式会导致返回值发生不必要的复制。为了让返回值被 <code>const</code> 修饰，且采取引用的方式来传值，需要显式地加上 <code>const &amp;</code>，上述代码可以改为：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T1</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token class-name">T2</span><span class="token operator">></span> <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token function">add</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>t1<span class="token punctuation">,</span> T<span class="token operator">&amp;</span> t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">decltype</span><span class="token punctuation">(</span>t1 <span class="token operator">+</span> t2<span class="token punctuation">)</span> t <span class="token operator">=</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span>    <span class="token keyword">return</span> t<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以利用 <code>decltype</code> 关键字，<code>decltype</code> 可以起到与 <code>const auto&amp;</code> 相同的作用：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 方式1.拖尾方式：decltype(返回值相关代码)</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T1</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">T2</span><span class="token operator">></span><span class="token keyword">auto</span> <span class="token function">larger</span><span class="token punctuation">(</span>T1 t1<span class="token punctuation">,</span> T2 t2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>t1 <span class="token operator">+</span> t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 方式2.与auto关键字结合：decltype(auto)</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T1</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">T2</span><span class="token operator">></span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token punctuation">)</span> <span class="token function">larger</span><span class="token punctuation">(</span>T1 t1<span class="token punctuation">,</span> T2 t2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> t1 <span class="token operator">+</span> t2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> c++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TensorRT课程笔记（3）</title>
      <link href="/2024/06/17/cuda-tensorrt-basic/"/>
      <url>/2024/06/17/cuda-tensorrt-basic/</url>
      
        <content type="html"><![CDATA[<h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>本篇文章程序链接：<a href="https://github.com/Shao-junliang/TensorRT-Course-Notes/tree/master/cuda-tensorrt-basic-api">https://github.com/Shao-junliang/TensorRT-Course-Notes/tree/master/cuda-tensorrt-basic-api</a></p><h3 id="模型构建"><a href="#模型构建" class="headerlink" title="模型构建"></a>模型构建</h3><ul><li><p>TensorRT 的工作流程如下图：</p> <img src="/2024/06/17/cuda-tensorrt-basic/tensorrt%E6%B5%81%E7%A8%8B.png" class="" title="推理流程">    <p> TensorRT 最终推理时需要一个 TensorRT Engine，这个 Engine 是由 TensorRT  Builder 构建，而 Builder 构建 Engine 时需要传入两个参数分别是：network, config；其中 network 是由 TensorRT Parser 解析的 ONNX 模型构建的。</p><ol><li><p>定义 builder, config 和network。</p><ul><li><code>createInferBuilder()</code> 创建 IBuilder 类的实例。</li><li><code>createBuilderConfig()</code> 创建构建器配置对象。</li><li><code>createNetworkV2</code> 创建网络定义对象。</li></ul></li><li><p>直接构建：设置模型结构、输入与输出信息。具体方法参考类：<code>INetworkDefinition</code>、<code>IBuilderConfig</code>；</p><p>ONNX导入：</p><ul><li>创建ONNX解析器 <code>createParser()</code>，通过 <code>parseFromFile()</code> 导入ONNX模型；</li><li>设置最大工作空间：<code>setMaxWorkspaceSize()</code>；</li><li>设置优化配置文件：<code>createOptimizationProfile()</code> 创建，配置最小、最大、最优的输入范围；</li><li>添加到配置对象中 <code>addOptimizationProfile()</code>，当模型有多个输入时，必须有多个 profile；</li></ul></li><li><p>生成 Engine 模型文件。</p><ul><li><code>buildEngineWithConfig()</code> 为给定的 <code>network</code> 和 <code>config</code> 构建引擎。<code>buildEngineWithConfig()</code> 在 TensorRT 8.0 中已弃用，新的构建方法：<code>buildSerializedNetwork()</code>；</li></ul></li><li><p>模型序列化：<code>serialize()</code> 将网络序列化为流<code>stream</code>，保存时直接保存<code>stream-&gt;data()</code>。</p></li></ol><p> 注意：builder、config等指针在结束时记得释放，否则会有内存泄漏，使用 <code>ptr-&gt;destroy()</code> 释放；<code>ptr-&gt;destroy()</code> 在 TRT 8.0 中已弃用，改用 <code>delete</code>。</p></li><li><p><a href="https://docs.nvidia.com/deeplearning/tensorrt/developer-guide/index.html#c_topics">官方文档参考部分 C++ API</a></p></li></ul><h3 id="模型推理"><a href="#模型推理" class="headerlink" title="模型推理"></a>模型推理</h3><p>执行推理的步骤：</p><ol><li><p>准备模型并加载。</p></li><li><p>创建 runtime：<code>createInferRuntime(logger)</code>。</p></li><li><p>反序列化创建 engine, 得为 engine 提供数据：<code>runtime-&gt;deserializeCudaEngine(modelData, modelSize)</code>,其中 <code>modelData</code> 包含的是 input 和 output 的名字，形状，大小和数据类型。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ModelData</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token operator">:</span>INPUT_NAME <span class="token operator">=</span> <span class="token string">"data"</span>INPUT_SHAPE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token comment">// [B, C, H, W]</span>OUTPUT_NAME <span class="token operator">=</span> <span class="token string">"prob"</span>OUTPUT_SIZE <span class="token operator">=</span> <span class="token number">10</span>DTYPE <span class="token operator">=</span> trt<span class="token punctuation">.</span>float32<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>从 engine 创建执行上下文：<code>engine-&gt;createExecutionContext()</code>。</p></li><li><p>创建 CUDA 流 <code>cudaStreamCreate(&amp;stream)</code>：</p><ol><li>CUDA 编程流是组织异步工作的一种方式，创建流来确定batch推理的独立；</li><li>为每个独立 batch 使用 <code>IExecutionContext</code> (第4步中已经创建了)，并为每个独立批次使用 cudaStreamCreate 创建 CUDA 流。</li></ol></li><li><p>数据准备：</p><ol><li><p>在 host 上初始化 <code>input</code> 数据并声明 <code>output</code> 数组大小，然后将 <code>input</code> 数据搬运到 gpu 上。</p></li><li><p>推理时，如果是动态输入，还需要明确输入数据的大小，利用 <code>setBindingDimensions()</code> 函数。</p></li><li><p>要执行 inference，必须用一个指针数组（bindings）指定<code>input</code>和<code>output</code>在gpu中的指针。</p><ul><li><p>bindings 为指针数组，表示 input 和 output 在 gpu 中的指针。比如 input 有 a，output 有 b, c, d，那么 bindings &#x3D; [a, b, c, d]，bindings[0] &#x3D; a，bindings[2] &#x3D; c。</p></li><li><p>可以通过 engine-&gt;getBindingDimensions(0) 获取指定 binding 索引（这里是索引 0）的张量维度信息。binding 索引是指模型输入和输出张量在 bindings 数组中的位置。</p></li><li><p>binding 索引：在 TensorRT 中，模型的输入和输出被称为 binding。这些 binding 在引擎创建时被确定，并且每个 binding 都有一个唯一的索引。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">float</span> <span class="token operator">*</span>bindings<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>input_data_device<span class="token punctuation">,</span> output_data_device<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 获取第0个binding的维度</span>nvinfer1<span class="token double-colon punctuation">::</span>Dims inputDims <span class="token operator">=</span> engine<span class="token operator">-></span><span class="token function">getBindingDimensions</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input dimensions: "</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> inputDims<span class="token punctuation">.</span>nbDims<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> inputDims<span class="token punctuation">.</span>d<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>推理并将 <code>output</code> 搬运回CPU。</p></li></ol></li><li><p>启动所有工作后，与所有流同步以等待结果: <code>cudaStreamSynchronize</code>。</p></li><li><p>按照与创建相反的顺序释放内存。</p></li></ol><h3 id="动态shape"><a href="#动态shape" class="headerlink" title="动态shape"></a>动态shape</h3><ul><li>网络构建阶段：<ol><li>必须在模型定义时，输入维度给定为 -1，否则该维度不会动态。 </li><li>配置 <code>profile</code>:<ul><li>create：<code>builder-&gt;createOptimizationProfile()</code>；</li><li>set：<code>setDimensions()</code>设置<code>kMIN</code>, <code>kOPT</code>, <code>kMAX</code>的输入尺寸范围；</li><li>add：<code>config-&gt;addOptimizationProfile(profile);</code>添加profile到网络配置中。</li></ul></li></ol></li><li>网络推理阶段：<ol><li>在选择 profile 的索引后设置 <code>input</code> 维度：<code>execution_context-&gt;setBindingDimensions(0, nvinfer1::Dims4());</code> </li><li>注意： 在运行时，向 engine 请求绑定维度会返回用于构建网络的相同维度。 即<code>engine.getBindingDimensions(0)</code> 得到的还是动态的维度 [-1, in_channel, -1, -1]；获取当前的实际维度，需要查询执行上下文： <code>context.getBindingDimensions(0)</code>。</li></ol></li></ul><h3 id="ONNX模型"><a href="#ONNX模型" class="headerlink" title="ONNX模型"></a>ONNX模型</h3><p>ONNX 模型是由微软和 Facebook 提出的一种表示深度学习的格式，主作用要是用来加速模型预测；也可以是作为深度学习模型互相转换之间的一个中转站，比如 torch–&gt;onnx–&gt;tensorrt；也可以利用 onnx 实现 torch–&gt;onnx–&gt;tensorflow；其中 torch 到 onnx 再到 tensorflow 的转换比较容易，但是 tensorflow–&gt;onnx–&gt;torch 个人感觉比较困难。</p><p>onnx 模型加速原理：主要通过动态量化实现，利用<strong>动态量化</strong>将 float32 得模型向量权重转化为 Int 类型，从而节省保存空间以及加速运算。</p><p>动态量化原理：根据四元组（min_val，max_val，qmin, qmax）来计算2个量化的参数，qmax 与 qmin 一般为127与-128，min_val 和 max_val 是从输入数据中的最大值与最小值，量化分数 <strong>scale</strong> &#x3D; max_val &#x2F; (( qmax-qmin)&#x2F;2)， zero_point 这个参数一般为0，量化后的权重 Q&#x3D;zero_point  + W&#x2F;(scale)。</p><ul><li>torch 的量化函数：torch.quantization.quantize_dynamic</li><li><a href="https://netron.app/">https://netron.app/</a> 该网站可以可视化 onnx 模型，当然有时候也可以可视化一些其它的深度学习模型。</li></ul><h4 id="onnx模型构成"><a href="#onnx模型构成" class="headerlink" title="onnx模型构成"></a>onnx模型构成</h4><p>onnx 模型：定义了可扩展的计算图模型、标准数据类型以及内置的运算符。主要是由图和节点组成的一层一层的层级结构。每一个计算流图都定义为由节点组成的列表，每个节点是一个 <strong>OP算子</strong>，可能有一个或多个输入与输出，并由这些节点构建有向无环图。 有的 onnx 算子未实现，比如pytorch中的 <code>BILSTM</code> 层转到 onnx 模型中的 <code>DynamicQuantizeLSTM</code> 算子就未实现。</p><ul><li>onnx 模型已实现的一些 OP 算子：<a href="https://onnx.ai/onnx/operators/index.html">https://onnx.ai/onnx/operators/index.html</a></li></ul><p>下图是一个 onnx 模型的所有参数了，其中最核心的就是 Graph（GraphProto）。</p><p>最核心的几个对象为：</p><ul><li>ModelProto、GraphProto 、NodeProto 、 ValueInfoProto 、 TensorProto 、 AttributeProto</li></ul><p>当我们加载了一个 ONNX 之后，我们获得的就是一个 <code>ModelProto</code>，它包含了一些版本信息，生产者信息和一个 <code>GraphProto</code>。在 <code>GraphProto</code> 里面又包含了四个 <code>repeated</code> 数组，它们分别是 <code>node</code>(<code>NodeProto</code>类型)，<code>input</code>(<code>ValueInfoProto</code>类型)，<code>output</code>(<code>ValueInfoProto</code>类型)和<code>initializer</code>(<code>TensorProto</code>类型)，其中 <code>node </code>中存放了模型中所有的计算节点，<code>input</code> 存放了模型的输入节点，<code>output</code> 存放了模型中所有的输出节点，<code>initializer</code> 存放了模型的所有权重参数。 每个计算节点中还包含了一个 <code>AttributeProto</code> 数组，用来描述该节点的属性，比如 <strong>Conv</strong> 节点或者说卷积层的属性包含 <code>group，pad，strides</code> 等等；</p><p>一个 node 主要由：input、output、name、<strong>op_type</strong>、domain、attribute 等组成。</p><h4 id="制作一个onnx节点"><a href="#制作一个onnx节点" class="headerlink" title="制作一个onnx节点"></a>制作一个onnx节点</h4><p>当下我们知道了一个 onnx 模型是由一个个的节点构成的图，在制作一个 onnx 模型时就是先搭建一个个的节点，然后将所有节点连接成一个图，最后将图与一些其他输入输出等信息组合在一起变成了一个Model。</p><p>在构建一个 onnx 模型时，可以利用 <strong>onnx.helper</strong> 方法提供的接口实现。具体可以参考<a href="https://github.com/onnx/onnx">onnx</a>的官网<a href="https://github.com/onnx/onnx/blob/main/onnx/helper.py">onnx&#x2F;helper.py</a>文件，具体如下： </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">helper<span class="token punctuation">.</span>make_tensor<span class="token punctuation">(</span>name<span class="token punctuation">,</span> data_type<span class="token punctuation">,</span> dims<span class="token punctuation">,</span> vals<span class="token punctuation">,</span> raw<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""name: tensor 名字data_type: 一个值，例如 onnx.TensorProto.FLOATdims(List[int]): 维度vals: 值raw(bool): 如果为真，则 vals 包含张量的序列化内容，否则，vals 应该是 *data_type* 定义的类型的值列表"""</span>helper<span class="token punctuation">.</span>make_tensor_value_info<span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>      elem_type<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>                          shape<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Sequence<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                              doc_string<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span>                              shape_denotation<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token triple-quoted-string string">""" 根据数据类型和形状创建一个 ValueInfoProto。 """</span>helper<span class="token punctuation">.</span>make_attribute<span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> doc_string<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token triple-quoted-string string">""" 根据值类型创建一个 AttributeProto。 """</span>helper<span class="token punctuation">.</span>make_node<span class="token punctuation">(</span>op_type<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> outputs<span class="token punctuation">,</span> name<span class="token punctuation">,</span> doc_string<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""inputs: 输入名称列表outputs: 输出名称列表doc_string: NodeProto 的可选文档字符串domain: NodeProto 的可选域。 如果它是 None，我们将只使用默认域（它是空的）kwargs: dict类型，节点的属性。 可接受的值记录在 make_attribute 方法中。"""</span>  helper<span class="token punctuation">.</span>make_graph<span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> name<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> outputs<span class="token punctuation">,</span> initializer<span class="token punctuation">,</span> doc_string<span class="token punctuation">,</span> value_info<span class="token punctuation">,</span> sparse_initializer<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""nodes: NodeProto 的列表inputs: ValueInfoProto 列表outputs: ValueInfoProto 列表initializer: TensorProto 列表value_info: ValueInfoProto 列表sparse_initializer: SparseTensorProto 列表"""</span>helper<span class="token punctuation">.</span>make_model<span class="token punctuation">(</span>graph<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token triple-quoted-string string">"""graph(GraphProto): make_graph 方法返回的图kwargs: 添加到返回实例的任何属性"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 另外两个比较常用的方法是对构造完的模型的检查和保存，分别定义在<a href="https://github.com/onnx/onnx/blob/main/onnx/checker.py">onnx&#x2F;checker.py</a>和<a href="https://github.com/onnx/onnx/blob/main/onnx/__init__.py">onnx&#x2F;<strong>init</strong>.py</a>中： </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">onnx<span class="token punctuation">.</span>checker<span class="token punctuation">.</span>check_model<span class="token punctuation">(</span><span class="token punctuation">)</span>onnx<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>总结一下构造一个 onnx 模型的具体流程：</p><p>1)根据自己的网络结构调用 make_node() 来创建相关节点，节点的 inputs 和 outputs 参数决定了后续 graph 的连接情况，节点的权值和信息通过调用 make_tensor() 和 make_tensor_value_info() 来创建，它们和节点的联系在于节点的 name；</p><p>2)上述三个方法构造的结构分别对应 make_graph() 中的三个参数，具体如下所示：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">a<span class="token punctuation">.</span>nodes<span class="token punctuation">:</span> make_node<span class="token punctuation">(</span><span class="token punctuation">)</span>b<span class="token punctuation">.</span>inputs<span class="token punctuation">:</span> make_tensor_value_info<span class="token punctuation">(</span><span class="token punctuation">)</span>c<span class="token punctuation">.</span>initializer<span class="token punctuation">:</span> make_tensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3)最后检查和保存模型即可</p><p>参考链接：<a href="https://blog.csdn.net/u014090429/article/details/120488773">https://blog.csdn.net/u014090429/article/details/120488773</a></p><h4 id="onnx导出注意事项"><a href="#onnx导出注意事项" class="headerlink" title="onnx导出注意事项"></a>onnx导出注意事项</h4><ul><li>对于任何用到 shape、size 返回值的参数时，例如：tensor.view(tensor.size(0), -1) 这类操作，避免直接使用 tensor.size 的返回值，而是加上int转换，tensor.view(int(tensor.size(0)), -1)，断开跟踪。</li><li>对于 nn.Upsample 或 nn.functional.interpolate 函数，使用 scale_factor 指定倍率，而不是使用 size 参数指定大小。</li><li>对于 reshape、view 操作时，-1 的指定请放到 batch 维度。其他维度可以计算出来即可。batch 维度禁止指定为大于 -1 的明确数字。</li><li>torch.onnx.export 指定 dynamic_axes 参数，并且只指定 batch 维度，禁止其他动态。</li><li>使用 opset_version&#x3D;11，不要低于 11。</li><li>避免使用 inplace 操作，例如 y[…, 0:2] &#x3D; y[…, 0:2] * 2 - 0.5。</li><li>尽量少的出现 5 个维度，例如 ShuffleNet Module，可以考虑合并 wh 避免出现 5 维。</li><li>尽量把预处理、后处理部分在 onnx 模型中实现，可以提高推理速度。</li></ul><h3 id="ONNX解析器"><a href="#ONNX解析器" class="headerlink" title="ONNX解析器"></a>ONNX解析器</h3><p>onnx 解析器有两种情况，libnvonnxparser.so 或者<a href="https://github.com/onnx/onnx-tensorrt">源代码</a>，so 文件一般用 CUDA\include 路径下的<code>NvOnnxParser.h</code> 文件。使用源代码可以更好的进行自定义封装，简化插件开发或者模型编译的过程，更加具有定制化，遇到问题可以调试；</p><p>源代码编译时需要注意 onnx 与 onnx-tensorrt 版本对应，如 onnx-tensorrt-8.0 版本对应关系：</p><ul><li>Protobuf &gt;&#x3D; 3.0.x</li><li>TensorRT 8.0.1.6</li></ul><ol><li><p>查看环境的 Protobuf 版本程序：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> google<span class="token punctuation">.</span>protobuf<span class="token keyword">print</span><span class="token punctuation">(</span>google<span class="token punctuation">.</span>protobuf<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>查看环境中 TensorRT 版本：</p><p>直接查看 TensorRT 路径下 include&#x2F;NvInferVersion.h 文件；</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NV_TENSORRT_MAJOR</span> <span class="token expression"><span class="token number">8</span> </span><span class="token comment">//!&lt; TensorRT major version.</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NV_TENSORRT_MINOR</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">//!&lt; TensorRT minor version.</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NV_TENSORRT_PATCH</span> <span class="token expression"><span class="token number">2</span> </span><span class="token comment">//!&lt; TensorRT patch version.</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NV_TENSORRT_BUILD</span> <span class="token expression"><span class="token number">4</span> </span><span class="token comment">//!&lt; TensorRT build number.</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="自定义插件-op"><a href="#自定义插件-op" class="headerlink" title="自定义插件(op)"></a>自定义插件(op)</h3><ol><li><p>导出 onnx 的时候，为 module 增加 symbolic 函数，实现自定义 op 算子。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MySigmoid</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>autograd<span class="token punctuation">.</span>Function<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token decorator annotation punctuation">@staticmethod</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 这样写会报错：IndexError: Argument passed to at() was not in the map.</span>        <span class="token comment"># return x * 1 / (1 + torch.exp(-x))   </span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token decorator annotation punctuation">@staticmethod</span>    <span class="token keyword">def</span> <span class="token function">symbolic</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> g<span class="token punctuation">.</span>op<span class="token punctuation">(</span><span class="token string">"MySigmoid"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span>                    g<span class="token punctuation">.</span>op<span class="token punctuation">(</span><span class="token string">"Constant"</span><span class="token punctuation">,</span> value_t<span class="token operator">=</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    attr1_s<span class="token operator">=</span><span class="token string">"string_attr"</span><span class="token punctuation">,</span>                    attr2_i<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                    attr3_f<span class="token operator">=</span><span class="token number">222.0</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">MyModel</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fill_<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>conv<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fill_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        x <span class="token operator">=</span> MySigmoid<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token keyword">return</span> x    <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    model <span class="token operator">=</span> Model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    dummy <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>    torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span>        model<span class="token punctuation">,</span>        <span class="token comment"># 输入给model的参数，需要传递tuple，因此用括号</span>        <span class="token punctuation">(</span>dummy<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment"># 模型保存路径</span>        <span class="token string">"./src/cuda-tensorrt-basic-api/static/plugin_demo.onnx"</span><span class="token punctuation">,</span>           <span class="token comment"># 是否打印详细信息</span>        verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>        <span class="token comment"># 输入节点与输出节点名称</span>        input_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        output_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"output"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment"># opset版本，</span>        opset_version<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>        <span class="token comment"># 通常，只设置batch为动态，其他的避免动态</span>        dynamic_axes<span class="token operator">=</span><span class="token punctuation">&#123;</span>            <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"batch"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"height"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">"width"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token string">"output"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"batch"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"height"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">"width"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token comment"># 对于插件，需要禁用onnx检查，这个参数只在 torch &lt; 1.10.0 版本存在</span>        <span class="token comment"># enable_onnx_checker=False</span>        operator_export_type<span class="token operator">=</span>OperatorExportTypes<span class="token punctuation">.</span>ONNX_FALLTHROUGH    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在 onnx-tensorrt 源代码解析的 builtin_op_importers.cpp 文件中，添加对自定义 op 的解析。添加方法可以参考 <code>FallbackPluginImporter</code> 算子。<strong>测试发现这一步跳过后也可以实现自定义插件</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">DEFINE_BUILTIN_OP_IMPORTER</span><span class="token punctuation">(</span>MySigmoid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\033[31m=======================call MySigmoid=======================033[0m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*     * OnnxAttrs 类用于处理和提取 ONNX 节点的属性。     * OnnxAttrs 类的构造函数接受一个节点和上下文对象，     * OnnxAttrs.get() 方法以键值对形式返回节点的属性；     */</span>    OnnxAttrs <span class="token function">attrs</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string pluginName<span class="token punctuation">&#123;</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string pluginVersion<span class="token punctuation">&#123;</span>attrs<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">"plugin_version"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string pluginNamespace<span class="token punctuation">&#123;</span>attrs<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">"plugin_namespace"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"Searching for plugin: "</span> <span class="token operator">&lt;&lt;</span> pluginName <span class="token operator">&lt;&lt;</span> <span class="token string">", plugin_version: "</span> <span class="token operator">&lt;&lt;</span> pluginVersion <span class="token operator">&lt;&lt;</span> <span class="token string">", plugin_namespace: "</span> <span class="token operator">&lt;&lt;</span> pluginNamespace<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 通过插件名称、版本和命名空间获取插件创建器</span>    nvinfer1<span class="token double-colon punctuation">::</span>IPluginCreator <span class="token operator">*</span>creator <span class="token operator">=</span> <span class="token function">importPluginCreator</span><span class="token punctuation">(</span>pluginName<span class="token punctuation">,</span> pluginVersion<span class="token punctuation">,</span> pluginNamespace<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ASSERT</span><span class="token punctuation">(</span>creator <span class="token operator">&amp;&amp;</span> <span class="token string">"Plugin not found, are the plugin name, version, and namespace correct?"</span><span class="token punctuation">,</span> ErrorCode<span class="token double-colon punctuation">::</span>kUNSUPPORTED_NODE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取插件的字段名称集合</span>    <span class="token keyword">const</span> nvinfer1<span class="token double-colon punctuation">::</span>PluginFieldCollection <span class="token operator">*</span>feildNames <span class="token operator">=</span> creator<span class="token operator">-></span><span class="token function">getFieldNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 字段数据需要进行类型擦除，用 fieldData 进行临时分配</span>    string_map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">>></span> fieldData<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// 加载字段，将字段数据和属性进行绑定</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>nvinfer1<span class="token double-colon punctuation">::</span>PluginField<span class="token operator">></span> fields <span class="token operator">=</span> <span class="token function">loadFields</span><span class="token punctuation">(</span>fieldData<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> feildNames<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建插件</span>    <span class="token keyword">const</span> <span class="token keyword">auto</span> plugin <span class="token operator">=</span> <span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token function">getNodeName</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span> creator<span class="token punctuation">,</span> fields<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ASSERT</span><span class="token punctuation">(</span>plugin <span class="token operator">&amp;&amp;</span> <span class="token string">"Could not create plugin"</span><span class="token punctuation">,</span> ErrorCode<span class="token double-colon punctuation">::</span>kUNSUPPORTED_NODE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建一个插件输入的向量</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>nvinfer1<span class="token double-colon punctuation">::</span>ITensor <span class="token operator">*</span><span class="token operator">></span> pluginInputs<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>input <span class="token operator">:</span> inputs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 将每个输入转换为 TensorRT 的张量并添加到插件输入向量中</span>        pluginInputs<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">convertToTensor</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"Successfully created plugin: "</span> <span class="token operator">&lt;&lt;</span> pluginName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 在 TensorRT 网络中添加插件层</span>    <span class="token keyword">auto</span> <span class="token operator">*</span>layer <span class="token operator">=</span> ctx<span class="token operator">-></span><span class="token function">network</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">addPluginV2</span><span class="token punctuation">(</span>pluginInputs<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pluginInputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注册插件层</span>    ctx<span class="token operator">-></span><span class="token function">registerLayer</span><span class="token punctuation">(</span>layer<span class="token punctuation">,</span> <span class="token function">getNodeName</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">RETURN_ALL_OUTPUTS</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>插件类继承 <code>nvinfer1::IPluginV2DynamicExt</code> 类，完成插件的具体实现。 </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">MySigmoidPlugin</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IPluginV2DynamicExt</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">MySigmoidPlugin</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string attr1<span class="token punctuation">,</span> <span class="token keyword">float</span> attr3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">MySigmoidPlugin</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">MySigmoidPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>    <span class="token comment">// ============================== 1.IPluginV2DynamicExt 类的纯虚函数 ==============================</span>    <span class="token comment">// 输出数据的尺寸</span>    <span class="token keyword">virtual</span> DimsExprs <span class="token function">getOutputDimensions</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span> outputIndex<span class="token punctuation">,</span> DimsExprs <span class="token keyword">const</span> <span class="token operator">*</span>inputs<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> nbInputs<span class="token punctuation">,</span> IExprBuilder <span class="token operator">&amp;</span>exprBuilder<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token comment">// 支持的数据类型，int8，float16，float32等</span>    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">supportsFormatCombination</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span> pos<span class="token punctuation">,</span> PluginTensorDesc <span class="token keyword">const</span> <span class="token operator">*</span>inOut<span class="token punctuation">,</span>                                           <span class="token keyword">int32_t</span> nbInputs<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> nbOutputs<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token comment">//  配置插件格式</span>    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">configurePlugin</span><span class="token punctuation">(</span>DynamicPluginTensorDesc <span class="token keyword">const</span> <span class="token operator">*</span>in<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> nbInputs<span class="token punctuation">,</span>                                 DynamicPluginTensorDesc <span class="token keyword">const</span> <span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> nbOutputs<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>    <span class="token comment">// 需要的额外空间大小</span>    <span class="token keyword">virtual</span> size_t <span class="token function">getWorkspaceSize</span><span class="token punctuation">(</span>PluginTensorDesc <span class="token keyword">const</span> <span class="token operator">*</span>inputs<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> nbInputs<span class="token punctuation">,</span> PluginTensorDesc <span class="token keyword">const</span> <span class="token operator">*</span>outputs<span class="token punctuation">,</span>                                    <span class="token keyword">int32_t</span> nbOutputs<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 推理具体逻辑</span>    <span class="token keyword">virtual</span> <span class="token keyword">int32_t</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>PluginTensorDesc <span class="token keyword">const</span> <span class="token operator">*</span>inputDesc<span class="token punctuation">,</span> PluginTensorDesc <span class="token keyword">const</span> <span class="token operator">*</span>outputDesc<span class="token punctuation">,</span>                            <span class="token keyword">void</span> <span class="token keyword">const</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span>inputs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span>outputs<span class="token punctuation">,</span>                            <span class="token keyword">void</span> <span class="token operator">*</span>workspace<span class="token punctuation">,</span> cudaStream_t stream<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token comment">// ============================== 2.IPluginV2Ext 类的纯虚函数 ==============================</span>    <span class="token keyword">virtual</span> nvinfer1<span class="token double-colon punctuation">::</span>DataType <span class="token function">getOutputDataType</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span> index<span class="token punctuation">,</span> nvinfer1<span class="token double-colon punctuation">::</span>DataType <span class="token keyword">const</span> <span class="token operator">*</span>inputTypes<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> nbInputs<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> inputTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ============================== 3.IPluginV2 类的纯虚函数 ==============================</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getPluginType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getPluginVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    size_t <span class="token function">getSerializationSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">getNbOutputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buffer<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    nvinfer1<span class="token double-colon punctuation">::</span>IPluginV2DynamicExt <span class="token operator">*</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">setPluginNamespace</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pluginNamespace<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getPluginNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string m_LayerName<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>string m_attr1<span class="token punctuation">;</span>    <span class="token keyword">float</span> m_attr3<span class="token punctuation">;</span>    size_t m_InputVolume<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>string m_Namespace<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>插件创建器，继承 <code>nvinfer1::IPluginCreator</code> 类，重写该基类的纯虚函数。creator 类主要记录了该 plugin 的名字、版本与命名空间等信息，并且可以生成该plugin类型，返回继承关系内更上层的  <code>nvinfer1::IPluginV2*</code> 指针。可以认为 creator 类是一个插件工厂类，用于插件的实例创建 。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">MySigmoidPluginCreator</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IPluginCreator</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">MySigmoidPluginCreator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*     * const char*：函数的返回类型是一个指向常量字符的指针。     * const: 类型限定符，表示这个成员函数是 const 的。const 成员函数保证不会修改它所属对象的成员变量。     * noexcept: 异常说明符，表示这个函数不会抛出异常。     * override: 表示这个成员函数重载了基类中的虚函数。使用 override 可以让编译器检查该函数是否确实覆盖了基类中的某个虚拟函数，如果没有覆盖成功，编译器会报错。     */</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getPluginName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getPluginVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> PluginFieldCollection <span class="token operator">*</span><span class="token function">getFieldNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    IPluginV2 <span class="token operator">*</span><span class="token function">createPlugin</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> PluginFieldCollection <span class="token operator">*</span>fc<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    IPluginV2 <span class="token operator">*</span><span class="token function">deserializePlugin</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>serialData<span class="token punctuation">,</span> size_t serialLength<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">setPluginNamespace</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pluginNamespace<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getPluginNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span> <span class="token keyword">override</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">static</span> PluginFieldCollection m_FC<span class="token punctuation">;</span>    <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PluginField<span class="token operator">></span> m_PluginAttributes<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>string m_Namespace<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在实现 plugin 类和 creator 类的 cpp 文件中对该 plugin 的 creator 进行注册， 采用宏<code>REGISTER_TENSORRT_PLUGIN</code> 注册插件：</p></li></ol>   <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">REGISTER_TENSORRT_PLUGIN</span><span class="token punctuation">(</span>MySigmoidPluginCreator<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参考链接：   <a href="https://docs.nvidia.com/deeplearning/tensorrt/archives/tensorrt-843/developer-guide/index.html#extending">Developer Guide :: NVIDIA Deep Learning TensorRT Documentation</a> </p><h3 id="简易插件封装集成"><a href="#简易插件封装集成" class="headerlink" title="简易插件封装集成"></a>简易插件封装集成</h3><p>在实现自定义插件时，主要实现的是 enqueue() 函数，其他函数主要是一些信息读取等操作。所以将一些重复度高或者说是不需要每次都改变的函数封装起来，每次只重写插件类里面的推理具体逻辑函数，即可完成插件的封装集成，提高工作效率。</p><h3 id="TensorRT-量化"><a href="#TensorRT-量化" class="headerlink" title="TensorRT 量化"></a>TensorRT 量化</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>TensorRT 支持使用 8 位整数来表示量化浮点值，量化方案包括激活和权重的量化。 </p><p>激活的量化方案取决于所选的校准算法，以找到最佳平衡特定数据的舍入误差和精度误差的比例 <a href="https://en.wikipedia.org/wiki/Rounding#Round_half_to_even">msub</a> 。</p><p>权重的量化方案如下：</p><p>$$ s &#x3D; {max(abs(x_{min}),abs(x_{max}))\over 127}$$</p><p>其中 \(x_{min}\)  和 \(x_{max}\)  是权重张量的浮点最小值和最大值。 </p><p>要启用任何量化操作，必须在构建器配置中设置 INT8 标志。 </p><h5 id="量化工作流程"><a href="#量化工作流程" class="headerlink" title="量化工作流程"></a>量化工作流程</h5><p> 创建量化网络有两种工作流程： </p><ol><li>训练后量化 (Post-training quantization，PTQ) 在网络训练后得出比例因子。TensorRT 为 PTQ 提供了一个称为校准的工作流程，当网络在代表性输入数据上执行时，它测量每个激活张量内激活的分布，然后使用该分布来估计张量的尺度值。</li><li>量化感知训练 (Quantization-aware training，QAT) 在训练期间计算比例因子。这允许训练过程补偿量化和反量化操作的影响。</li></ol><h5 id="显示量化与隐式量化"><a href="#显示量化与隐式量化" class="headerlink" title="显示量化与隐式量化"></a>显示量化与隐式量化</h5><p>量化网络有两种方式表示：显示量化与隐式量化。</p><p>在隐式量化网络中，每个量化张量都有一个关联的 scale。当读取和写入张量时，scale 用于隐式量化和反量化值。在处理隐式量化网络时，TensorRT 在应用图优化时将模型视为浮点模型，并适时使用 INT8 来优化层执行时间。如果某个层在 INT8 中运行得更快，那么它就会在 INT8 中执行。否则，将使用 FP32 或 FP16。在此模式下，TensorRT 仅针对性能进行优化，并且几乎无法控制 INT8 的使用位置 - 即使在 API 级别显式设置了层的精度，TensorRT 也可能会在图形优化期间将该层与另一个层融合，并丢失必须在 INT8 中执行的信息。 TensorRT 的 PTQ 功能会生成隐式量化网络。 </p><p>在显式量化网络中，量化值和未量化值之间转换的缩放操作由图中的 <code>IQuantizeLayer</code>  和 <code>IDequantizeLayer</code> 节点显式表示，这些节点可以称为 <code>Q/DQ</code> 节点。与隐式量化相比，显式形式准确指定执行与 INT8 之间的转换的位置，并且优化器将仅执行由模型语义决定的精度转换，即使：</p><ul><li>添加额外的转换可以提高层精度（例如，选择 FP16 内核实现而不是 INT8 实现）。</li><li>添加额外的转换会导致引擎执行速度更快（例如，选择 INT8 内核实现来执行指定为具有浮点精度的层，反之亦然）。</li></ul><p>ONNX 使用显式量化表示 - 当 PyTorch 或 TensorFlow 中的模型导出到 ONNX 时，框架图中的每个假量化操作都导出为 Q，后跟 DQ。由于 TensorRT 保留了这些层的语义，因此模型准确性非常接近原框架中的精度。虽然优化保留了量化和反量化的位置，但它们可能会更改模型中浮点运算的顺序，因此结果不会按位相同。</p><h5 id="张量量化与通道量化"><a href="#张量量化与通道量化" class="headerlink" title="张量量化与通道量化"></a>张量量化与通道量化</h5><ul><li>张量量化（Per-tensor quantization）：对每个张量使用相同的量化参数，使用单个 scale（标量）来缩放整个张量。 </li><li>通道量化（Per-channel quantization）：对每个通道（例如卷积层的每个滤波器或特征图）使用不同的量化参数。</li></ul><p>使用显式量化时，权重可以使用张量量化或通道量化来进行量化。在这两种情况下，量化尺度的精度都是FP32。激活（activation）只能使用张量量化。 </p><h4 id="设置动态范围"><a href="#设置动态范围" class="headerlink" title="设置动态范围"></a>设置动态范围</h4><p>TensorRT 提供了直接设置动态范围（必须由量化张量表示的范围）的 API，以支持隐式量化，其中这些值是在 TensorRT 之外计算的。该 API 允许使用最小值和最大值来设置张量的动态范围。由于 TensorRT 目前仅支持对称范围，因此使用 <code>max(abs(min_float), abs(max_float))</code> 计算缩放比例。请注意，当 <code>abs(min_float) != abs(max_float)</code> 时，TensorRT 使用比配置更大的动态范围，这可能会增加舍入误差。对于将在 INT8 中执行的操作，所有浮点输入和输出都需要动态范围。可以利用 <code>setDynamicRange</code> 设置张量的动态范围：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">tensor<span class="token operator">-></span><span class="token function">setDynamicRange</span><span class="token punctuation">(</span>min_float<span class="token punctuation">,</span> max_float<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="使用校准进行训练后量化"><a href="#使用校准进行训练后量化" class="headerlink" title="使用校准进行训练后量化"></a>使用校准进行训练后量化</h4><p>在训练后量化中，TensorRT 会为网络中的每个张量计算一个缩放值( scale )。这个过程称为校准，需要提供具有代表性的输入数据，TensorRT 在这些数据上运行网络以收集每个激活张量的统计信息。所需的输入数据量取决于具体应用。</p><p>对于激活张量的统计信息，决定最佳缩放值并不是一门精确的科学，这需要在量化表示中的两种误差来源之间进行平衡：离散化误差（当每个量化值所表示的范围变大时增加）和截断误差（值被钳制到可表示范围的极限）。因此，TensorRT 提供了多种不同的校准器，这些校准器以不同方式计算 scale 。校准器包含：<code>IInt8EntropyCalibrator2</code> 、 <code>IInt8EntropyCalibrator</code> 、<code>IInt8MinMaxCalibrator</code>、<code>IInt8LegacyCalibrator</code> 。</p><p>校准批次大小也会影响 <code>IInt8EntropyCalibrator2</code> 和 <code>IInt8EntropyCalibrator</code> 的截断误差。 </p><p>构建 INT8 引擎时，构建器执行以下步骤：</p><ol><li>构建一个 32 位引擎，在校准集上运行它，并为每个张量记录激活值分布的直方图。</li><li>根据直方图构建一个校准表，为每个张量提供一个缩放值。</li><li>使用校准表和网络定义构建 INT8 引擎。</li></ol><p>校准可能很慢，因此第 2 步（校准表）的输出可以缓存和重用。这在给定平台上多次构建相同网络时非常有用，且所有校准器都支持这一功能。</p><p>在运行校准之前，TensorRT 会查询校准器实现，查看它是否有访问缓存表的权限。如果有，它会直接进入第 3 步。缓存数据作为指针和长度传递。可以在此处找到一个示例校准表。</p><p>只要校准在层融合之前进行，校准缓存数据在不同设备之间是可移植的。</p><h5 id="使用c-进行-INT8-校准"><a href="#使用c-进行-INT8-校准" class="headerlink" title="使用c++进行 INT8 校准"></a>使用c++进行 INT8 校准</h5><p>要向 TensorRT 提供校准数据，请实现 <code>IInt8Calibrator</code> 接口。</p><p>构建器按以下步骤调用校准器：</p><ol><li>首先，它会查询接口以获取批量大小，并调用 <code>getBatchSize()</code> 来确定预期的输入批量大小。</li><li>然后，它会反复调用 <code>getBatch()</code> 以获取输入批次。批次必须完全符合 <code>getBatchSize()</code> 返回的批量大小。当没有更多批次时，<code>getBatch()</code> 必须返回 <code>false</code>。</li></ol><p>在实现校准器后，可以将其配置到构建器中使用：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">config<span class="token operator">-></span><span class="token function">setInt8Calibrator</span><span class="token punctuation">(</span>calibrator<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>要缓存校准表，请实现 <code>writeCalibrationCache()</code> 和 <code>readCalibrationCache()</code> 方法。</p>]]></content>
      
      
      
        <tags>
            
            <tag> CUDA </tag>
            
            <tag> TensorRT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TensorRT课程笔记（2）</title>
      <link href="/2024/05/31/cuda-runtime-basic/"/>
      <url>/2024/05/31/cuda-runtime-basic/</url>
      
        <content type="html"><![CDATA[<h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>本篇文章程序链接：<a href="https://github.com/Shao-junliang/TensorRT-Course-Notes/tree/master/cuda-runtime-api">https://github.com/Shao-junliang/TensorRT-Course-Notes/tree/master/cuda-runtime-api</a></p><h3 id="1-上下文"><a href="#1-上下文" class="headerlink" title="1. 上下文"></a>1. 上下文</h3><ol><li><p>CUDA Runtime是封装了CUDA Driver的高级别更友好的API。</p></li><li><p>cudaruntime需要引入cudart这个so文件。</p></li><li><p>上下文管理：</p><ul><li><p>使用<code>cuDevicePrimaryCtxRetain</code>为每个设备设置context，不再手工管理context，并且不提供直接管理context的API。</p></li><li><p>任何依赖CUcontext的API被调用时，会触发CUcontext的创建和对设备的绑定。</p><ul><li>此后任何API调用时，会以设备id为基准，调取绑定好的CUcontext。</li><li>这种模式被称为懒加载模式，避免了手动维护CUcontext的麻烦。</li></ul></li></ul></li><li><p>cuda的状态返回值，都是<code>cudaError_t</code>类型，通过check宏捕获状态并处理是一种通用方式。</p><ul><li>官方案例采用宏，并非本例程序里的函数加宏。</li><li>函数加宏具有更加好的便利性 。</li></ul></li></ol><h3 id="2-内存"><a href="#2-内存" class="headerlink" title="2. 内存"></a>2. 内存</h3><ol><li>关于内存模型，请参考：<a href="https://www.bilibili.com/video/BV1jX4y1w7Um">https://www.bilibili.com/video/BV1jX4y1w7Um</a><ul><li>内存大体可分为<ul><li>主机内存：Host Memory，也就是CPU内存，内存；</li><li>设备内存：Device Memory，也就是GPU内存，显存；<ul><li>设备内存又分为（括号里的数字表示到计算芯片的距离）：<ul><li>寄存器内存(1)：Register Memory</li><li>纹理内存(2)：Texture Memory</li><li>共享内存(2)：Shared Memory</li><li>常量内存(2)：Constant Memory</li><li>全局内存(3)：Global Memory</li><li>本地内存(3)：Local Memory</li></ul></li><li><strong>距离计算芯片越近，计算速度就越快</strong>，空间越小，价格越贵。</li></ul></li></ul></li></ul></li><li>通过<code>cudaMalloc</code>分配GPU内存，分配到setDevice指定的当前设备上。</li><li>通过<code>cudaMallocHost</code>分配page locked memory，即pinned memory，页锁定内存。<ul><li>页锁定内存是主机内存，CPU可以直接访问。</li><li>页锁定内存也可以被GPU直接访问，使用DMA（Direct Memory Access）技术。<ul><li>注意这么做的性能会比较差，因为主机内存距离GPU太远，隔着PCIE等，不适合大量数据传输。</li></ul></li><li>页锁定内存是物理内存，过度使用会导致系统性能低下（导致虚拟内存等一系列技术变慢）。</li></ul></li><li>内存拷贝：<code>cudaMemcpy</code><ul><li>如果host不是页锁定内存，则：<ul><li><p>Device To Host的过程，等价于：</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">pinned = cudaMallocHost // 创建锁页内存copy Device to pinned// 拷贝Device数据到pinnedcopy pinned to Host// 拷贝pinned数据到Hostfree pinned// 释放内存<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Host To Device的过程，等价于：</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">pinned = cudaMallocHost// 创建锁页内存copy Host to pinned// 拷贝Host数据到pinnedcopy pinned to Device// 拷贝pinned数据到Devicefree pinned// 释放内存<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li>如果host是页锁定内存，则：<ul><li>Device To Host的过程，等价于：copy Device to Host</li><li>Host To Device的过程，等价于：copy Host to Device</li></ul></li></ul></li></ol><h3 id="3-流"><a href="#3-流" class="headerlink" title="3. 流"></a>3. 流</h3><ol><li>stream是一个流句柄，可以当做是一个队列。<ul><li>cuda执行器从 stream 中一条条的读取指令并执行；如<code>cudaMemcpyAsync</code>函数等同于向stream这个队列中加入一个cudaMemcpy指令并排队；</li><li>使用到stream的函数，在向stream中加入指令后立即返回，并不会等待指令执行结束；</li><li>通过<code>cudaStreamSynchronize</code>函数，等待stream中所有指令执行完毕，也就是队列为空，即同步操作。</li></ul></li><li>当使用stream时，注意：<strong>由于异步函数会立即返回，因此传递进入的参数要考虑其生命周期，应确认函数调用结束后再做释放</strong>。</li><li>还可以向stream中加入Event，用以监控是否到达了某个检查点，具体流程：<ul><li><code>cudaEventCreate</code>，创建事件;</li><li><code>cudaEventRecord</code>，记录事件；在stream中加入某个事件，当队列执行到该事件后，修改其状态;</li><li><code>cudaEventQuery</code>，查询事件当前状态；</li><li><code>cudaEventElapsedTime</code>，计算两个事件之间经历的时间间隔，若要统计某些核函数执行时间，请使用这个函数，能够得到最准确的统计；</li><li><code>cudaEventSynchronize</code>，同步某个事件，等待事件到达；</li><li><code>cudaStreamWaitEvent</code>，等待流中的某个事件；</li></ul></li><li>默认流，对于cudaMemcpy等同步函数，其等价于执行了：<ul><li><code>cudaMemcpyAsync</code>(… 默认流) 加入队列；</li><li><code>cudaStreamSynchronize</code>(默认流) 等待执行完成；</li><li>默认流与当前设备上下文类似，是与当前设备进行的关联。因此，如果大量使用默认流，会导致性能低下。</li></ul></li></ol><h3 id="4-核函数"><a href="#4-核函数" class="headerlink" title="4. 核函数"></a>4. 核函数</h3><p>cu文件可以当做正常cpp写即可，它是cpp的超集，兼容支持cpp的所有特性。</p><ol><li><p>cu文件中引入的一些新的符号和语法：</p><ul><li><p><code>__global__</code>标记，核函数标记，调用方必须是host，返回值必须是void；</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">kernel</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">float</span><span class="token operator">*</span> pdata<span class="token punctuation">,</span> <span class="token keyword">int</span> ndata<span class="token punctuation">)</span><span class="token comment">// 调用方式，"&lt;&lt;&lt; >>>"参数类型是：&lt;&lt;&lt;dim3 gridDim, dim3 blockDim, size_t bytesSharedMemorySize, cudaStream_t stream>>></span>kernel<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>gridDim<span class="token punctuation">,</span> blockDim<span class="token punctuation">,</span> bytesSharedMemorySize<span class="token punctuation">,</span> stream<span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">(</span>pdata<span class="token punctuation">,</span> ndata<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>其中gridDim, blockDim, bytesSharedMemory, stream是线程layout参数；</li><li>gridDim 与 blockDim 都是 <code>dim3</code> 类型，<code>dim3</code>有构造函数<code>dim3(int x, int y=1, int z=1)</code>，因此当直接赋值为int时，实则定义了<code>dim.x = value, dim.y = 1, dim.z = 1</code></li><li>如果指定了stream，则把核函数加入到stream中异步执行；pdata和ndata则是核函数的函数调用参数；</li><li>核函数调用参数必须传值，不能传引用，参数可以是类类型等；</li><li>核函数执行时无论stream是否为nullptr，都将是异步执行；</li><li>因此在核函数中进行printf操作时，必须进行等待，例如<code>cudaDeviceSynchronize</code>、或者<code>cudaStreamSynchronize</code>，否则将无法看到打印的信息。</li></ul></li><li><p><code>__device__</code>标记，设备调用的函数，调用方必须是device。</p></li><li><p><code>__host__</code>标记，主机调用函数，调用方必须是主机；也可以<code>__device__</code> <code>__host__</code>两个标记同时有，表明该函数可以设备也可以主机。</p></li><li><p><code>__constant__</code>标记，定义常量内存。</p></li><li><p><code>__shared__</code>标记，定义共享内存。</p></li><li><p>通过cudaPeekAtLastError&#x2F;cudaGetLastError函数，捕获核函数是否出现错误或者异常。</p></li><li><p>内存索引的计算公式</p></li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">:</span>    position <span class="token operator">*=</span> dims<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    position <span class="token operator">+=</span> indexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>buildin变量，内置变量。</p><ul><li>所有核函数都可以访问，其取值由执行器维护和改变；</li><li>gridDim[x, y, z]：网格维度，线程布局的大小，在核函数启动时指定；</li><li>blockDim[x, y, z]：块维度，线程布局的大小，在核函数启动时指定；</li><li>blockIdx[x, y, z]：块索引，对应最大值为gridDim，由执行器根据当前执行的线程进行赋值，核函数内访问时已经被配置好；</li><li>threadIdx[x, y, z]：线程索引，对应最大值是blockDim，由执行器根据当前执行的线程进行赋值，核函数内访问时已经被配置好；</li><li>Dim是固定的，启动后不会改变，并且是Idx的最大值；</li><li>每个Dim都具有x、y、z三个维度，分别以z、y、x为高低顺序。</li></ul></li><li><p>thread, grid, block 和 threadIdx</p><ul><li><p>如果假设一个Grid相当于一个立方体，如图所示:</p><img src="/2024/05/31/cuda-runtime-basic/organization-of-threads.jpg" class="" title="Grids"> <p>图为一个gridDim[2, 2, 2]的girds，每一个小立方体为一个block，图中的block为blockDim[6, 6, 3]，其中绿色位置的小方块则代表一个block中的thread；</p></li><li><p>threadIdx表示的含义为thread的1D idx，所以先确定知道在第几个block里，再确定在这个block里的第几个thread。</p></li><li><p>一个核函数只能有一个grid，一个grid可以有很多个block，每个block可以有很多的线程。</p></li></ul></li></ol><h3 id="5-layout"><a href="#5-layout" class="headerlink" title="5. layout"></a>5. layout</h3><ol><li>layout是设置核函数执行的线程数，包括最大线程数、每个块的最大线程数、 以及warp的大小。 <ul><li>maxGridSize对应gridDim的取值最大值；</li><li>maxThreadsDim对应blockDim的取值最大值；</li><li>warpSize对应线程束中的线程数量；</li><li>maxThreadsPerBlock对应blockDim元素乘积最大值；</li></ul></li><li>layout的4个主要变量的关系：<ul><li>gridDim是layout维度，其对应的索引是blockIdx，blockIdx最大值为 [0, gridDim-1]。</li><li>blockDim是layout维度，其对应的索引是threadIdx，threadIdx最大值为 [0, blockDim-1]，blockDim维度乘积必须小于等于maxThreadsPerBlock。</li><li>gridDim、blockDim为维度，启动核函数后是固定的；</li><li>blockIdx、threadIdx为索引，启动核函数后，枚举每一个维度值，不同线程取值不同。</li></ul></li><li>核函数启动时，&lt;&lt;&lt;&gt;&gt;&gt;的参数分别为：&lt;&lt;&lt;gridDim, blockDim, shraed_memory_size, cudaStream_t&gt;&gt;&gt;，shared_memory_size为共享内存（shared memory）大小。</li><li>对于一维数组时，通常只定义layout的x维度，若处理的是二维，则可以考虑定义x、y维度，如单通道图像。</li></ol><h3 id="6-共享内存"><a href="#6-共享内存" class="headerlink" title="6. 共享内存"></a>6. 共享内存</h3><ol><li><p><code>sharedMemPerBlock</code> 为block中最大可用的共享内存，可以利用共享内存使得 block 内的threads相互通信。</p><img src="/2024/05/31/cuda-runtime-basic/example.jpg" class="" title="sharedMemPerBlock 的应用案例"> </li><li><p>共享内存是片上内存，更靠近计算单元，因此比globalMem速度更快，通常可以充当缓存使用。</p><ul><li>数据先读入到sharedMem，做各类计算时，使用sharedMem而非globalMem</li></ul></li><li><p><code>demo_kernel&lt;&lt;&lt;1, 1, 12, nullptr&gt;&gt;&gt;()</code>；其中第三个参数12，是指定动态共享内存dynamic_shared_memory的大小，单位是bytes，也就是说可以安全存放3个float。</p><ul><li>dynamic_shared_memory变量必须使用 <code>extern __shared__</code>开头；</li><li>并且定义为不确定大小的数组 <code>[]</code>；</li><li>变量在函数外部与内部定义效果都一样；</li><li>其指针由cuda调度器执行时赋值；</li></ul></li><li><p>static_shared_memory作为静态分配的共享内存。</p><ul><li>不加extern，以<code>__shared__</code>开头；</li><li>定义时需要明确数组的大小；</li><li>静态分配的地址比动态分配的地址低；</li></ul></li><li><p>动态共享变量，无论定义多少个，地址都一样。</p></li><li><p>静态共享变量，定义几个地址随之叠加。</p></li><li><p>如果配置的各类共享内存总和大于<code>sharedMemPerBlock</code>，则核函数执行出错，<code>Invalid argument</code></p><ul><li>不同类型的静态共享变量定义，其内存划分并不一定是连续的；</li><li>中间会有内存对齐策略，使得第一个和第二个变量之间可能存在空隙；</li><li>因此如果变量之间存在空隙，可能小于全部大小的共享内存时就会报错。</li></ul></li></ol><h3 id="7-atomic"><a href="#7-atomic" class="headerlink" title="7. atomic"></a>7. atomic</h3><ol><li>atomicAdd是原子加法，同类型原子操作有很多，如原子减法等；</li><li>输出的数组需要预先分配空间，如[cuda-runtime-api-9-atomic.cpp][]的：output_capacity；</li><li>最后统计结果的时候记得取min，int output_size &#x3D; min(output_host[0], output_capacity)；<ul><li>因为核函数中，add的次数可能会超过capacity大小，导致后续访问越界的发生；</li></ul></li><li>输出的数组可能会乱序，即不同执行时刻结果不同。这是因为cuda是并行的，调度顺序不确定；<ul><li>因此capacity一定要比预期的最大值大一些，才可能保证结果不会丢失；</li><li>可以通过储存index，然后在cpu上执行一次排序，实现有序输出；</li></ul></li><li>此类型的代码实现是模型后处理的关键，是处理动态数组的关键。</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">float</span> <span class="token operator">*</span>parray <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span><span class="token function">checkRuntime</span><span class="token punctuation">(</span><span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_device<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// parray 是这样的数据格式：[count, box1, box2, ……]，count 为 int，box1 为 yolo 检测结果的结构体；</span><span class="token comment">// atomicAdd(parray, 1) 的操作相当于是 count += 1, 但是返回的是没有 +1 之前的 old_count;</span><span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">atomicAdd</span><span class="token punctuation">(</span>parray<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-仿射变换"><a href="#8-仿射变换" class="headerlink" title="8. 仿射变换"></a>8. 仿射变换</h3><ol><li><p>仿射变换+双线性插值，在CV场景下，解决图像预处理是非常合适的。如Yolo的letterbox，实则是边缘填充；CenterNet的居中对齐；</p></li><li><p>在仿射核函数里，循环的次数为dst.width * dst.height，以dst为参照集；因此，无论src多大，dst固定的话，计算量也是固定的。</p></li><li><p>仿射变换的公式推导。</p><ul><li><p>旋转变换：<br>$$<br>\begin{bmatrix} x’ \\ y’ \end{bmatrix} &#x3D; \begin{bmatrix} cos(\theta) &amp; sin(\theta) \\ -sin(\theta) &amp; cos(\theta) \end{bmatrix} \begin{bmatrix} x \\ y \end{bmatrix}<br>$$</p></li><li><p>缩放变换：<br>$$<br>\begin{bmatrix} x’ \\ y’ \end{bmatrix} &#x3D; \begin{bmatrix} scale_x &amp; 0 \\ 0 &amp; scale_y \end{bmatrix} \begin{bmatrix} x \\ y \end{bmatrix}<br>$$</p></li><li><p>平移变换：<br>$$<br>\begin{bmatrix} x’ \\ y’ \end{bmatrix} &#x3D; \begin{bmatrix} 1 &amp; 0 \\ 0 &amp; 1 \end{bmatrix} \begin{bmatrix} x \\ y \end{bmatrix} + \begin{bmatrix} \Delta x \\ \Delta y \end{bmatrix}<br>$$</p></li><li><p>旋转 + 缩放：<br>$$<br>\begin{bmatrix} x’ \\ y’ \end{bmatrix} &#x3D; \begin{bmatrix} cos(\theta)*scale_x  &amp; sin(\theta)*scale_y \\ -sin(\theta)*scale_x &amp; cos(\theta)*scale_y \end{bmatrix} \begin{bmatrix} x \\ y \end{bmatrix}<br>$$</p></li><li><p>旋转 + 缩放 + 平移：<br>$$<br>\begin{bmatrix} x’ \\ y’ \\ z’ \end{bmatrix} &#x3D; \begin{bmatrix} cos(\theta)*scale_x  &amp; sin(\theta)*scale_y &amp; \Delta x \\ -sin(\theta)*scale_x &amp; cos(\theta)*scale_y &amp; \Delta y \\ 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} x \\ y \\ 1 \end{bmatrix}<br>$$</p></li></ul></li></ol><h3 id="9-thrust特性"><a href="#9-thrust特性" class="headerlink" title="9. thrust特性"></a>9. thrust特性</h3><ol><li>thrust是cuda开发的，基于cuda的stl库。</li><li>对于thrust中的lambda表达式，需要增加__device__标记表明函数可以被核函数调用；由于使用到了device vector，因此编译环境需要修改为nvcc编译，且cpp文件要改为cu文件；此时需要在xmake中添加nvcc工具链，具体可参考<a href="https://xmake.io/#/zh-cn/guide/configuration?id=%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7%E9%93%BE">自定义工具链</a></li><li>内存的复制和分配，被cuda封装。</li></ol><h3 id="10-error"><a href="#10-error" class="headerlink" title="10. error"></a>10. error</h3><ol><li>由于cuda核函数是异步执行，如果cuda核函数出错，立即执行<code>cudaPeekAtLastError</code>时只会拿到对输入参数校验是否正确的状态，而不会拿到核函数是否执行正确的状态，所以此时拿到的状态码为：<code>no error</code>。</li><li>因此一般等待核函数执行完毕后，才可以知道当前核函数是否出错，一般通过设备同步或者流同步进行等待。</li><li>错误分为可恢复和不可恢复两种：<ul><li>可恢复：<ul><li>参数配置错误等，例如block越界（一般最大值是1024），shared memory大小超出范围（一般是48KB）；</li><li>通过cudaGetLastError可以获取错误代码，同时把当前状态恢复为success；</li><li>该错误在调用核函数后可以立即通过cudaGetLastError&#x2F;cudaPeekAtLastError拿到；</li><li>该错误在下一个函数调用的时候会覆盖；</li></ul></li><li>不可恢复：<ul><li>核函数执行错误，例如访问越界等等异常；</li><li>该错误则会传递到之后的所有cuda操作上；</li><li>错误状态通常需要等到核函数执行完毕才能够拿到，也就是有可能在后续的任何流程中突然异常（因为是异步的）。</li></ul></li></ul></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> CUDA </tag>
            
            <tag> TensorRT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TensorRT课程笔记（1）</title>
      <link href="/2024/05/29/cuda-driver-basic/"/>
      <url>/2024/05/29/cuda-driver-basic/</url>
      
        <content type="html"><![CDATA[<h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>本篇文章程序链接：<a href="https://github.com/Shao-junliang/TensorRT-Course-Notes/tree/master/cuda-driver-api">https://github.com/Shao-junliang/TensorRT-Course-Notes/tree/master/cuda-driver-api</a></p><h3 id="1-显卡，显卡驱动，nvcc-cuda-driver-cudatoolkit-cudnn到底是什么？"><a href="#1-显卡，显卡驱动，nvcc-cuda-driver-cudatoolkit-cudnn到底是什么？" class="headerlink" title="1. 显卡，显卡驱动，nvcc, cuda driver,cudatoolkit,cudnn到底是什么？"></a>1. 显卡，显卡驱动，nvcc, cuda driver,cudatoolkit,cudnn到底是什么？</h3><ol><li><p>关于显卡驱动与cuda驱动的版本匹配。</p><ul><li><a href="https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html">Table 1. CUDA 11.6 Update 1 Component Versions</a></li><li>结论：尽量将显卡驱动升级到新的，因为显卡驱动向下兼容cuda驱动。</li></ul></li><li><p>简单了解显卡相关概念：</p><ul><li>显卡：GPU</li><li>显卡驱动：驱动软件，类比声卡驱动，摄像头驱动；</li><li>GPU架构：gpu架构指的是硬件的设计方式，例如是否有L1 or L2缓存；</li><li>CUDA: 其中一种理解是它是一种编程语言（像c++,python等，只不过它是专门用来操控GPU的）；</li><li>cudnn: 这个其实就是一个专门为深度学习计算设计的软件库，里面提供了很多专门的计算函数；</li><li>CUDAToolkit：这是我们真正需要首先安装的工具包，所谓的装cuda首先指的是它；它里面包含了许多库，例如：cudart, cublas等；</li><li>其他涉及到的知识有nvcc与nvidia-smi, 多个 cuda 版本之间进行切换, cuda的安装等；详细请参考: <a href="https://zhuanlan.zhihu.com/p/91334380">https://zhuanlan.zhihu.com/p/91334380</a></li></ul></li><li><p>cuda-driver-api 与 cuda-runtime-api</p><ul><li>CUDA Driver与CUDA Runtime相比更偏底层，就意味着Driver API有着更灵活的控制，也伴随着更复杂的编程。</li><li>因此CUDA driver需要做显式的初始化<code>cuInit(0)</code>，否则其他API都会返回<code>CUDA_ERROR_NOT_INITIALIZED</code></li><li>经过初始化后驱动和显卡的信息可以轻松获取：</li></ul></li></ol><ul><li>驱动版本管理 <a href="https://docs.nvidia.com/cuda/archive/11.2.0/cuda-driver-api/group__CUDA__VERSION.html#group__CUDA__VERSION">https://docs.nvidia.com/cuda/archive/11.2.0/cuda-driver-api/group__CUDA__VERSION.html#group__CUDA__VERSION</a><ul><li>设备信息管理 <a href="https://docs.nvidia.com/cuda/archive/11.2.0/cuda-driver-api/group__CUDA__DEVICE.html">https://docs.nvidia.com/cuda/archive/11.2.0/cuda-driver-api/group__CUDA__DEVICE.html</a></li><li>CUDA的在线文档地址<ol><li><a href="https://developer.nvidia.com/cuda-toolkit-archive">https://developer.nvidia.com/cuda-toolkit-archive</a></li><li><a href="https://docs.nvidia.com/cuda/archive/11.2.0/">https://docs.nvidia.com/cuda/archive/11.2.0/</a></li></ol></li></ul></li></ul><h3 id="2-使用宏定义来检查是否有做cuda初始化"><a href="#2-使用宏定义来检查是否有做cuda初始化" class="headerlink" title="2. 使用宏定义来检查是否有做cuda初始化"></a>2. 使用宏定义来检查是否有做cuda初始化</h3><ol><li>CUDA driver需要做显式的初始化<code>cuInit(0)</code>，否则其他API都会返回<code>CUDA_ERROR_NOT_INITIALIZED</code>;</li><li>采用宏定义可以在每次调用API前都检查初始化;</li><li>采用封装带参宏定义使代码更清晰、好调试，养成一种良好的编码习惯也是很重要！</li></ol><h3 id="3-context的概念和使用方法"><a href="#3-context的概念和使用方法" class="headerlink" title="3. context的概念和使用方法"></a>3. context的概念和使用方法</h3><ol><li><p>设备与特定进程相关连的所有状态。比如，写的一段kernel code对GPU的使用会造成不同状态（内存映射、分配、加载的code），Context则保存着所有的管理数据来控制和使用设备。</p><ul><li>gpu 的 context 相当于 cpu 的 program，一块gpu上可以有多个contexts，但是它们之间是相互隔离的。建议一块设备就一个context。参考：<a href="https://dragan.rocks/articles/18/Interactive-GPU-Programming-3-CUDA-Context">https://dragan.rocks/articles/18/Interactive-GPU-Programming-3-CUDA-Context</a></li></ul></li><li><p>上下文管理可以干的事儿：</p><ul><li>持有分配的内存列表；</li><li>持有加载进该设备的kernel code</li><li>cpu与gpu之间的unified memory</li></ul></li><li><p>如何管理上下文：</p><ol><li>在cuda driver同样需要显式管理上下文<ul><li>开始时<code>cuCtxCreate()</code>创建上下文，结束时<code>cuCtxDestroy</code>销毁上下文。像文件管理一样须手动开关。用<code>cuDevicePrimaryCtxRetain()</code>创建上下文更好！</li><li><code>cuCtxGetCurrent()</code>获取当前上下文；</li><li>可以使用堆栈管理多个上下文<code>cuCtxPushCurrent()</code>压入，<code>cuCtxPopCurrent()</code>推出；</li><li>对ctxA使用<code>cuCtxPushCurrent()</code>和<code>cuCtxCreate()</code>都相当于将ctxA放到栈顶（让它成为current context）</li></ul></li><li>cuda runtime可以自动创建，是基于<code>cuDevicePrimaryCtxRetain()</code>创建的。</li></ol></li></ol><h3 id="4-内存分配"><a href="#4-内存分配" class="headerlink" title="4. 内存分配"></a>4. 内存分配</h3><ol><li><p>统一内存(Unified addressing) ；</p></li><li><p>分配线性内存<code>cuMemAlloc()</code>：</p><ul><li><p>线性内存：线性内存被组织在单个连续的地址空间中，可以直接以及线性地访问这些内存位置。</p></li><li><p>内存分配空间以字节为大小，并返回所分配的内存地址</p></li></ul></li><li><p>分配主机锁页内存<code>cuMemAllocHost()</code>:</p><ul><li>参考：<a href="https://leimao.github.io/blog/Page-Locked-Host-Memory-Data-Transfer/">https://leimao.github.io/blog/Page-Locked-Host-Memory-Data-Transfer/</a></li><li>参考：<a href="https://www.youtube.com/watch?v=p9yZNLeOj4s">https://www.youtube.com/watch?v=p9yZNLeOj4s</a></li></ul><ol><li>锁页内存：</li></ol><ul><li>定义：页面不允许被调入调出的叫锁页内存，反之叫可分页内存；<ul><li>优点：快；</li><li>a. 设备可以直接访问内存，与可分页内存相比，它的读写带宽要高得多；</li><li>b. 驱动程序会跟踪使用<code>cuMemAllocHost()</code>分配的虚拟内存范围，并自动加速对<code>cuMemcpy()</code>等函数的调用；</li><li>使用注意：分配过多锁业内存会减少系统可用于分页的内存量，可能会降低系统性能。因此，在主机和设备之间为数据交换分配临时区域时，最好少用此功能。</li></ul></li></ul><ol start="2"><li>这里是从主机分配内存，因此不是输入device prt的地址，而是一个主机的二级地址。</li></ol></li><li><p>内存的初始化<code>cuMemsetD32(CUdeviceptr dstDevice, unsigned int  ui, size_t N)</code>, 将N个32位值的内存范围设置为指定的值ui。</p></li><li><p>内存的释放<code>cuMemFreeHost()</code>: 有借有还 再借不难~</p></li></ol><p><strong>声明</strong>: 本文部分内容来源于网络，如有侵权请联系删除。 </p>]]></content>
      
      
      
        <tags>
            
            <tag> CUDA </tag>
            
            <tag> TensorRT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>摄像头取流</title>
      <link href="/2024/05/13/camera-capture-stream/"/>
      <url>/2024/05/13/camera-capture-stream/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本节主要阐述摄像头取流的几种方式，分别为SDK取流、流媒体取流；</p><h2 id="SDK取流"><a href="#SDK取流" class="headerlink" title="SDK取流"></a>SDK取流</h2><p>“SDK取流”是指通过软件开发工具包（SDK，Software Development Kit）从设备或服务中获取实时或录制的视频流数据的过程。此技术广泛应用于视频监控、实时视频传输、视频分析等领域。利用SDK提供的接口，开发者可以实现视频的接收、解码、显示以及存储等功能，使得视频数据的处理更加高效和灵活。通过SDK取流，能够方便地与各种视频源进行对接，满足不同应用场景下的需求。</p><h3 id="海康"><a href="#海康" class="headerlink" title="海康"></a>海康</h3><p>海康摄像头获取图像主要流程可以直接参考官方文档， <a href="https://open.hikvision.com/osp#%E8%AE%BE%E5%A4%87%E9%9B%86%E6%88%90SDK">海康开放平台 </a>。海康SDK取流主要流程图：</p> <img src="/2024/05/13/camera-capture-stream/HIK%E5%8F%96%E6%B5%81%E8%BF%87%E7%A8%8B.png" class="" title="Hik取流过程"><p>启动预览后通过实时数据回调拿到流并解码成图像；</p><p>预览实时流解码有两种方式：</p><ol><li>预览接口<code>NET_DVR_RealPlay_V40</code>中预览参数的播放窗口句柄（hPlayWnd）赋值为有效句柄，则由SDK自动实现解码显示功能。在初始化SDK和注册设备两步骤后，直接调用启动预览和停止预览接口即可。正常开启预览之后可以调用<code>NET_DVR_RigisterDrawFun</code>注册画图回调函数（仅Windows版本支持），回调获取窗口DC，然后用户可以自己在窗口表层绘图或者写字。如果预览的码流是音视频复合流，也可以调用声音预览控制相关接口实现打开或者关闭声音、客户端音量控制等功能，相关接口有：<code>NET_DVR_OpenSound</code>、<code>NET_DVR_CloseSound</code>、<code>NET_DVR_OpenSoundShare</code>、<code>NET_DVR_CloseSoundShare</code>、<code>NET_DVR_Volume</code>等。</li><li>预览接口<code>NET_DVR_RealPlay_V40</code>中预览参数的播放窗口句柄（hPlayWnd）可以设置为空值，直接设置回调函数，或者调用预览接口之后，通过<code>NET_DVR_SetRealDataCallBack</code>、<code>NET_DVR_SetStandardDataCallBack</code>设置回调函数，回调获取实时流数据（前两个接口设置的回调获取的是PS封装的码流，后者获取的是标准RTP封装的码流）之后用户后续自己处理，比如二进制流方式写入文件保存成录像或者调用播放库解码显示等操作。</li></ol><p> 代码实现：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"HCNetSDK.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"PlayM4.h"</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>LONG lPort <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 全局的播放库port号</span><span class="token keyword">typedef</span> <span class="token function">HWND</span><span class="token punctuation">(</span>WINAPI <span class="token operator">*</span>PROCGETCONSOLEWINDOW<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>PROCGETCONSOLEWINDOW GetConsoleWindowAPI<span class="token punctuation">;</span><span class="token keyword">void</span> CALLBACK <span class="token function">DecodeDataCallBack</span><span class="token punctuation">(</span><span class="token keyword">long</span> nPort<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">long</span> nSize<span class="token punctuation">,</span> FRAME_INFO <span class="token operator">*</span>pFrameInfo<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>nUser<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>nReserved2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// TODO 将流转为BGR图像显示；</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> CALLBACK <span class="token function">g_RealDataCallBack_V30</span><span class="token punctuation">(</span>LONG lRealHandle<span class="token punctuation">,</span> DWORD dwDataType<span class="token punctuation">,</span> BYTE <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> DWORD dwBufSize<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dwUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// HWND hWnd = GetConsoleWindowAPI();</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>dwDataType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> NET_DVR_SYSHEAD<span class="token operator">:</span> <span class="token comment">// 系统头</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lPort <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 该通道取流之前已经获取到句柄，后续接口不需要再调用</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PlayM4_GetPort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lPort<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 获取播放库未使用的通道号</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// m_iPort = lPort; //第一次回调的是系统头，将获取的播放库port号赋值给全局port，下次回调数据时即使用此port号播放</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dwBufSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PlayM4_SetStreamOpenMode</span><span class="token punctuation">(</span>lPort<span class="token punctuation">,</span> STREAME_REALTIME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 设置实时流播放模式</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PlayM4_OpenStream</span><span class="token punctuation">(</span>lPort<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> dwBufSize<span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 打开流接口</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PlayM4_SetDecodeEngineEx</span><span class="token punctuation">(</span>lPort<span class="token punctuation">,</span> SOFT_DECODE_ENGINE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 设置解码模式，SOFT_DECODE_ENGINE 软解、HARD_DECODE_ENGINE 硬解</span>            <span class="token punctuation">&#123;</span>                cout <span class="token operator">&lt;&lt;</span> <span class="token string">" cur decode mode is:"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">PlayM4_GetDecodeEngine</span><span class="token punctuation">(</span>lPort<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 打印解码类型</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PlayM4_SetDecCallBackMend</span><span class="token punctuation">(</span>lPort<span class="token punctuation">,</span> DecodeDataCallBack<span class="token punctuation">,</span> dwUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 解码回调函数</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PlayM4_Play</span><span class="token punctuation">(</span>lPort<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 播放开始</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> NET_DVR_STREAMDATA<span class="token operator">:</span> <span class="token comment">// 码流数据</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dwBufSize <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lPort <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PlayM4_InputData</span><span class="token punctuation">(</span>lPort<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> dwBufSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">// 其他数据</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dwBufSize <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lPort <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PlayM4_InputData</span><span class="token punctuation">(</span>lPort<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> dwBufSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> CALLBACK <span class="token function">g_ExceptionCallBack</span><span class="token punctuation">(</span>DWORD dwType<span class="token punctuation">,</span> LONG lUserID<span class="token punctuation">,</span> LONG lHandle<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> tempbuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>dwType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> EXCEPTION_RECONNECT<span class="token operator">:</span> <span class="token comment">// 预览时重连</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"----------reconnect--------%d\n"</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 设备初始化</span>    <span class="token function">NET_DVR_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置连接时间与重连时间</span>    <span class="token function">NET_DVR_SetConnectTime</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">NET_DVR_SetReconnect</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置异常消息回调函数</span>    <span class="token function">NET_DVR_SetExceptionCallBack_V30</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> g_ExceptionCallBack<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取控制台窗口句柄</span>    <span class="token comment">// HMODULE hKernel32 = GetModuleHandle("kernel32");</span>    <span class="token comment">// GetConsoleWindowAPI = (PROCGETCONSOLEWINDOW)GetProcAddress(hKernel32, "GetConsoleWindow");</span>    <span class="token comment">// 注册设备</span>    LONG lUserID<span class="token punctuation">;</span>    <span class="token comment">// 登录参数，包括设备地址、登录用户、密码等</span>    NET_DVR_USER_LOGIN_INFO struLoginInfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    struLoginInfo<span class="token punctuation">.</span>bUseAsynLogin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                       <span class="token comment">// 同步登录方式</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>struLoginInfo<span class="token punctuation">.</span>sDeviceAddress<span class="token punctuation">,</span> <span class="token string">"xxx.xxx.xxx.xxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设备IP地址</span>    struLoginInfo<span class="token punctuation">.</span>wPort <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>                            <span class="token comment">// 设备服务端口</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>struLoginInfo<span class="token punctuation">.</span>sUserName<span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 设备登录用户名</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>struLoginInfo<span class="token punctuation">.</span>sPassword<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 设备登录密码</span>    <span class="token comment">// 设备信息, 输出参数</span>    NET_DVR_DEVICEINFO_V40 struDeviceInfoV40 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// 用户注册设备</span>    lUserID <span class="token operator">=</span> <span class="token function">NET_DVR_Login_V40</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>struLoginInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>struDeviceInfoV40<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lUserID <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Login failed, error code: %d\n"</span><span class="token punctuation">,</span> <span class="token function">NET_DVR_GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">NET_DVR_Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 启动预览并设置回调数据流；</span>    <span class="token comment">/*    预览接口NET_DVR_RealPlay_V40中预览参数的播放窗口句柄（hPlayWnd）赋值为有效句柄，则由SDK自动实现解码显示功能。    若（hPlayWnd）设置为空值，直接设置回调函数，    或者调用预览接口之后，通过NET_DVR_SetRealDataCallBack、NET_DVR_SetStandardDataCallBack设置回调函数，回调获取实时流数据    */</span>    LONG lRealPlayHandle<span class="token punctuation">;</span>    NET_DVR_PREVIEWINFO struPlayInfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    struPlayInfo<span class="token punctuation">.</span>hPlayWnd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">// 需要SDK解码时句柄设为有效值，仅取流不解码时可设为空</span>    struPlayInfo<span class="token punctuation">.</span>lChannel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 预览通道号</span>    struPlayInfo<span class="token punctuation">.</span>dwStreamType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 0-主码流，1-子码流，2-码流3，3-码流4，以此类推</span>    struPlayInfo<span class="token punctuation">.</span>dwLinkMode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">// 0- TCP方式，1- UDP方式，2- 多播方式，3- RTP方式，4-RTP/RTSP，5-RSTP/HTTP</span>    struPlayInfo<span class="token punctuation">.</span>bBlocked <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 0- 非阻塞取流，1- 阻塞取流</span>    <span class="token comment">// 启动预览</span>    lRealPlayHandle <span class="token operator">=</span> <span class="token function">NET_DVR_RealPlay_V40</span><span class="token punctuation">(</span>lUserID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>struPlayInfo<span class="token punctuation">,</span> g_RealDataCallBack_V30<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lRealPlayHandle <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"NET_DVR_RealPlay_V40 error, %d\n"</span><span class="token punctuation">,</span> <span class="token function">NET_DVR_GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">NET_DVR_Logout</span><span class="token punctuation">(</span>lUserID<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">NET_DVR_Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//---------------------------------------</span>    <span class="token comment">// 关闭预览</span>    <span class="token function">NET_DVR_StopRealPlay</span><span class="token punctuation">(</span>lRealPlayHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 释放播放库资源</span>    <span class="token function">PlayM4_Stop</span><span class="token punctuation">(</span>lPort<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">PlayM4_CloseStream</span><span class="token punctuation">(</span>lPort<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">PlayM4_FreePort</span><span class="token punctuation">(</span>lPort<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注销用户</span>    <span class="token function">NET_DVR_Logout</span><span class="token punctuation">(</span>lUserID<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">NET_DVR_Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="大华"><a href="#大华" class="headerlink" title="大华"></a>大华</h3><p>大华摄像头获取图像主要流程可以直接参考官方文档，<a href="https://support.dahuatech.com/tools/sdkExploit">设备网络SDK</a> 。大华SDK取流主要流程图：</p> <img src="/2024/05/13/camera-capture-stream/DH%E5%8F%96%E6%B5%81%E8%BF%87%E7%A8%8B.png" class="" title="DH取流过程"><p>启动预览后通过实时数据回调拿到流并解码成图像；</p><p>预览实时流解码有两种方式：</p><ol><li>在预览接口<code>CLIENT_RealPlayEx</code>中的播放窗口句柄为有效句柄，则由SDK实现解码功能。</li><li>用户可以通过设置预览接口<code>CLIENT_RealPlayEx</code>中的播放窗口句柄为NULL，并通过调用设置实时预览数据回调接口(<code>CLIENT_SetRealDataCallBack</code>或<code>CLIENT_SetRealDataCallBackEx</code>)，获取码流数据进行后续解码播放处理。</li></ol><p>代码实现：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dhnetsdk.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"dhplay.h"</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">long</span> g_lRealPort <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 全局播放库port号</span><span class="token keyword">void</span> CALLBACK <span class="token function">RealDataCallBackEx2</span><span class="token punctuation">(</span>LLONG lRealHandle<span class="token punctuation">,</span> DWORD dwDataType<span class="token punctuation">,</span> BYTE <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> DWORD dwBufSize<span class="token punctuation">,</span> LLONG param<span class="token punctuation">,</span> LDWORD dwUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    BOOL bInput <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> lRealHandle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>dwDataType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>            <span class="token comment">// 原始音视频混合数据</span>            bInput <span class="token operator">=</span> <span class="token function">PLAY_InputData</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> dwBufSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bInput<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input data error: %d\n"</span><span class="token punctuation">,</span> <span class="token function">PLAY_GetLastError</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>            <span class="token comment">// 标准视频数据</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>            <span class="token comment">// yuv 数据</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>            <span class="token comment">// pcm 音频数据</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>            <span class="token comment">// 原始音频数据</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> CALLBACK <span class="token function">DecDataCallBack</span><span class="token punctuation">(</span><span class="token keyword">long</span> nPort<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBuf<span class="token punctuation">,</span> <span class="token keyword">long</span> nSize<span class="token punctuation">,</span> FRAME_INFO <span class="token operator">*</span>pFrameInfo<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pUser<span class="token punctuation">,</span> <span class="token keyword">long</span> nReserved2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// TODO 将流转为BGR图像显示；</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> szCommand<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> nChannelID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 初始化</span>    <span class="token function">CLIENT_Init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    NET_IN_LOGIN_WITH_HIGHLEVEL_SECURITY stInparam<span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stInparam<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stInparam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    stInparam<span class="token punctuation">.</span>dwSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stInparam<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strncpy</span><span class="token punctuation">(</span>stInparam<span class="token punctuation">.</span>szIP<span class="token punctuation">,</span> <span class="token string">"xxx.xxx.xxx.xxx"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stInparam<span class="token punctuation">.</span>szIP<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strncpy</span><span class="token punctuation">(</span>stInparam<span class="token punctuation">.</span>szUserName<span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stInparam<span class="token punctuation">.</span>szUserName<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">strncpy</span><span class="token punctuation">(</span>stInparam<span class="token punctuation">.</span>szPassword<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stInparam<span class="token punctuation">.</span>szPassword<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    stInparam<span class="token punctuation">.</span>nPort <span class="token operator">=</span> <span class="token number">37777</span><span class="token punctuation">;</span>    stInparam<span class="token punctuation">.</span>emSpecCap <span class="token operator">=</span> EM_LOGIN_SPEC_CAP_TCP<span class="token punctuation">;</span>    NET_OUT_LOGIN_WITH_HIGHLEVEL_SECURITY stOutparam<span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stOutparam<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stOutparam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    stOutparam<span class="token punctuation">.</span>dwSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stOutparam<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注册用户到设备</span>    LLONG lLoginHandle <span class="token operator">=</span> <span class="token function">CLIENT_LoginWithHighLevelSecurity</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stInparam<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stOutparam<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lLoginHandle <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"registration failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 获取播放库端口号</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PLAY_GetFreePort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_lRealPort<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to get free port. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 设置流播放模式；STREAME_REALTIME实时模式(默认);STREAME_FILE文件流模式;实时模式</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PLAY_SetStreamOpenMode</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">,</span> STREAME_REALTIME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to set streaming mode. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 打开流播放</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PLAY_OpenStream</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">900</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to open stream. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 设置解码回调流类型，流类型：1 视频流;2 音频流;3 复合流;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PLAY_SetDecCBStream</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to set decoding callback stream type. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 设置解码回调，相比于PLAY_SetDecCallBack函数，用户可以自定义回调参数；</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PLAY_SetDecCallBackEx</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">,</span> DecDataCallBack<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to set decoding callback. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 开始播放</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PLAY_Play</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to play. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 启动实时预览或多画面预览。</span>    LLONG lPlayHandle <span class="token operator">=</span> <span class="token function">CLIENT_RealPlayEx</span><span class="token punctuation">(</span>lLoginHandle<span class="token punctuation">,</span> nChannelID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DH_RType_Realplay_0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> lPlayHandle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 设置回调函数处理数据</span>        <span class="token function">CLIENT_SetRealDataCallBackEx2</span><span class="token punctuation">(</span>lPlayHandle<span class="token punctuation">,</span> RealDataCallBackEx2<span class="token punctuation">,</span> <span class="token punctuation">(</span>LDWORD<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> REALDATA_FLAG_RAW_DATA <span class="token operator">|</span> REALDATA_FLAG_DATA_WITH_FRAME_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fail to play!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">PLAY_Stop</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">PLAY_CloseStream</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 关闭解码库播放</span>    <span class="token function">PLAY_Stop</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 释放播放库</span>    <span class="token function">PLAY_CloseStream</span><span class="token punctuation">(</span>g_lRealPort<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 关闭预览</span>    <span class="token function">CLIENT_StopRealPlayEx</span><span class="token punctuation">(</span>lPlayHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注销用户</span>    <span class="token function">CLIENT_Logout</span><span class="token punctuation">(</span>lLoginHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 释放SDK资源</span>    <span class="token function">CLIENT_Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="宇视"><a href="#宇视" class="headerlink" title="宇视"></a>宇视</h3><p>宇视摄像头获取图像主要流程可以直接参考官方文档，  <a href="https://unisee.uniview.com/home/resource">宇视开放平台</a> 。宇视SDK取流主要流程图：</p> <img src="/2024/05/13/camera-capture-stream/YS%E5%8F%96%E6%B5%81%E8%BF%87%E7%A8%8B.png" class="" title="YS取流过程"><p>启动预览后通过实时数据回调拿到流并解码成图像；</p><p>代码实现：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"NetDEVSDK.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">void</span> STDCALL <span class="token function">YSRealDataCallBack</span><span class="token punctuation">(</span>LPVOID lpPlayHandle<span class="token punctuation">,</span> <span class="token keyword">const</span> BYTE <span class="token operator">*</span>pucBuffer<span class="token punctuation">,</span> INT32 dwBufSize<span class="token punctuation">,</span> INT32 dwMediaDataType<span class="token punctuation">,</span> LPVOID lpUserParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> STDCALL <span class="token function">YSDecDataCallBack</span><span class="token punctuation">(</span>LPVOID lpPlayHandle<span class="token punctuation">,</span> <span class="token keyword">const</span> NETDEV_PICTURE_DATA_S <span class="token operator">*</span>pstPictureData<span class="token punctuation">,</span> LPVOID lpUserParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// TODO 将YUV转为BGR图像显示；</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 初始化</span>    <span class="token function">NETDEV_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置连接时间</span>    NETDEV_REV_TIMEOUT_S stRevTimeout <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    stRevTimeout<span class="token punctuation">.</span>dwRevTimeOut <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    stRevTimeout<span class="token punctuation">.</span>dwFileReportTimeOut <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>    <span class="token function">NETDEV_SetRevTimeOut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stRevTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 登录参数，包括设备地址、登录用户、密码等</span>    NETDEV_DEVICE_LOGIN_INFO_S stDevLoginInfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">strncpy</span><span class="token punctuation">(</span>stDevLoginInfo<span class="token punctuation">.</span>szIPAddr<span class="token punctuation">,</span> <span class="token string">"xxx.xxx.xxx.xxx"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stDevLoginInfo<span class="token punctuation">.</span>szIPAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设备IP地址</span>    <span class="token function">strncpy</span><span class="token punctuation">(</span>stDevLoginInfo<span class="token punctuation">.</span>szUserName<span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stDevLoginInfo<span class="token punctuation">.</span>szUserName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设备登录用户名</span>    <span class="token function">strncpy</span><span class="token punctuation">(</span>stDevLoginInfo<span class="token punctuation">.</span>szPassword<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stDevLoginInfo<span class="token punctuation">.</span>szPassword<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设备登录密码</span>    stDevLoginInfo<span class="token punctuation">.</span>dwPort <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>                                                           <span class="token comment">// 设备服务端口</span>    stDevLoginInfo<span class="token punctuation">.</span>dwLoginProto <span class="token operator">=</span> NETDEV_LOGIN_PROTO_ONVIF<span class="token punctuation">;</span>                               <span class="token comment">// 登录协议</span>    <span class="token comment">// 输出参数，仅私有协议登录有效</span>    NETDEV_SELOG_INFO_S stSELogInfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// 设备登陆</span>    LPVOID lUserID <span class="token operator">=</span> <span class="token function">NETDEV_Login_V30</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stDevLoginInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stSELogInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> lUserID<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Login failed, error code: %d\n"</span><span class="token punctuation">,</span> <span class="token function">NETDEV_GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 释放SDK资源</span>        <span class="token function">NETDEV_Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 通道查询</span>    NETDEV_VIDEO_CHL_DETAIL_INFO_EX_S stVideoChlDetailInfoEx<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 分配128个通道</span>    INT32 dwCount <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>                                                 <span class="token comment">// 128个通道</span>    BOOL bRet <span class="token operator">=</span> <span class="token function">NETDEV_QueryVideoChlDetailListEx</span><span class="token punctuation">(</span>lUserID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwCount<span class="token punctuation">,</span> stVideoChlDetailInfoEx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>FALSE <span class="token operator">==</span> bRet <span class="token operator">&amp;&amp;</span> NETDEV_E_NEEDMOREDATA <span class="token operator">==</span> <span class="token function">NETDEV_GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 默认分配数组大小小于实际通道数，重新分配内存获取</span>        NETDEV_VIDEO_CHL_DETAIL_INFO_EX_S <span class="token operator">*</span>pstVideoChlDetailInfoEx <span class="token operator">=</span> <span class="token keyword">new</span> NETDEV_VIDEO_CHL_DETAIL_INFO_EX_S<span class="token punctuation">[</span>dwCount<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">memset</span><span class="token punctuation">(</span>pstVideoChlDetailInfoEx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>NETDEV_VIDEO_CHL_DETAIL_INFO_EX_S<span class="token punctuation">)</span> <span class="token operator">*</span> dwCount<span class="token punctuation">)</span><span class="token punctuation">;</span>        bRet <span class="token operator">=</span> <span class="token function">NETDEV_QueryVideoChlDetailListEx</span><span class="token punctuation">(</span>lUserID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwCount<span class="token punctuation">,</span> pstVideoChlDetailInfoEx<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 释放分配内存</span>        <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pstVideoChlDetailInfoEx<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 实况预览</span>    <span class="token comment">// HWND hWnd = GetConsoleWindow(); // 获取窗口句柄 和海康大华一样 不用走窗口句柄</span>    NETDEV_PREVIEWINFO_S stNetInfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    stNetInfo<span class="token punctuation">.</span>dwChannelID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    stNetInfo<span class="token punctuation">.</span>hPlayWnd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 窗口句柄设为空</span>    stNetInfo<span class="token punctuation">.</span>dwStreamType <span class="token operator">=</span> NETDEV_LIVE_STREAM_INDEX_MAIN<span class="token punctuation">;</span>    stNetInfo<span class="token punctuation">.</span>dwLinkMode <span class="token operator">=</span> NETDEV_TRANSPROTOCAL_RTPTCP<span class="token punctuation">;</span>    stNetInfo<span class="token punctuation">.</span>dwFluency <span class="token operator">=</span> NETDEV_PICTURE_FLUENCY<span class="token punctuation">;</span>    <span class="token comment">// 启动预览并设置回调数据流</span>    LPVOID lpPlayHandle <span class="token operator">=</span> <span class="token function">NETDEV_RealPlay</span><span class="token punctuation">(</span>lUserID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stNetInfo<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> lpPlayHandle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RealPlay failed, error code: %d\n"</span><span class="token punctuation">,</span> <span class="token function">NETDEV_GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RealPlay success, handle: %p\n"</span><span class="token punctuation">,</span> lpPlayHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 注册原始码流</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NETDEV_SetPlayDataCallBack</span><span class="token punctuation">(</span>lpPlayHandle<span class="token punctuation">,</span> YSRealDataCallBack<span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SetPlayDataCallBack failed, error code: %d\n"</span><span class="token punctuation">,</span> <span class="token function">NETDEV_GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 注册解码后视频媒体流数据</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">NETDEV_SetPlayDecodeVideoCB</span><span class="token punctuation">(</span>lpPlayHandle<span class="token punctuation">,</span> YSDecDataCallBack<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SetPlayDecodeVideoCB failed, error code: %d\n"</span><span class="token punctuation">,</span> <span class="token function">NETDEV_GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 停止实况预览</span>    <span class="token function">NETDEV_StopRealPlay</span><span class="token punctuation">(</span>lpPlayHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注销用户</span>    <span class="token function">NETDEV_Logout</span><span class="token punctuation">(</span>lUserID<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 释放SDK资源</span>    <span class="token function">NETDEV_Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="流媒体取流"><a href="#流媒体取流" class="headerlink" title="流媒体取流"></a>流媒体取流</h2><p>流媒体取流是一种实时获取和传输多媒体内容的技术，广泛应用于视频监控、直播、点播等领域。它通过网络将音视频数据从源设备传输到目标设备，实现即时播放和处理。流媒体取流技术不仅能够有效降低延迟，保证播放的流畅性，还支持多种协议和编码格式，适应不同的网络环境和应用需求。通过优化的取流策略，流媒体取流可以在带宽受限的条件下依然提供高质量的音视频体验。</p><h3 id="lal取流"><a href="#lal取流" class="headerlink" title="lal取流"></a>lal取流</h3><p> <a href="https://github.com/q191201771/lal">lalserver</a>是纯Golang开发的流媒体（直播音视频网络传输）服务器。目前已支持RTMP, RTSP(RTP&#x2F;RTCP), HLS, HTTP[S]&#x2F;WebSocket-FLV&#x2F;TS, GB28181协议。并支持通过插件形式进行二次开发扩展。 </p><p>启动lalserver.exe，通过下面的程序将rtsp地址转rtmp拉流。 </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cpr/cpr.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;json/json.h></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">bool</span> <span class="token function">StartStream</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>url<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>stream_name<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>play_url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>string post_url <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:8083/api/ctrl/start_relay_pull"</span><span class="token punctuation">;</span>    Json<span class="token double-colon punctuation">::</span>Value data<span class="token punctuation">;</span>    data<span class="token punctuation">[</span><span class="token string">"stream_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> stream_name<span class="token punctuation">;</span>    data<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span> <span class="token operator">=</span> url<span class="token punctuation">;</span>    data<span class="token punctuation">[</span><span class="token string">"pull_retry_num"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>string json_data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">toStyledString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置HTTP头和JSON数据</span>    cpr<span class="token double-colon punctuation">::</span>Header headers<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    cpr<span class="token double-colon punctuation">::</span>Body body <span class="token operator">=</span> cpr<span class="token double-colon punctuation">::</span>Body<span class="token punctuation">&#123;</span>json_data<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// 发送POST请求</span>    cpr<span class="token double-colon punctuation">::</span>Response response <span class="token operator">=</span> cpr<span class="token double-colon punctuation">::</span><span class="token function">Post</span><span class="token punctuation">(</span>cpr<span class="token double-colon punctuation">::</span>Url<span class="token punctuation">&#123;</span>post_url<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> body<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 检查HTTP请求是否成功</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 打印HTTP响应内容</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"send HTTP ok:\n"</span>                  <span class="token operator">&lt;&lt;</span> response<span class="token punctuation">.</span>text <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        play_url <span class="token operator">=</span>            <span class="token string">"rtmp://127.0.0.1:1935/live/"</span> <span class="token operator">+</span> stream_name<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"send HTTP err: "</span> <span class="token operator">&lt;&lt;</span> response<span class="token punctuation">.</span>status_code <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>string url <span class="token operator">=</span> <span class="token string">"rtsp://username:password@ip/media/video2"</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>string stream_name <span class="token operator">=</span> <span class="token string">"234"</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>string _play_url<span class="token punctuation">;</span>    <span class="token function">StartStream</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> stream_name<span class="token punctuation">,</span> _play_url<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 也可以用ffmpeg 将 rtmp 流发布到 lalserver </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ffmpeg <span class="token parameter variable">-re</span> <span class="token parameter variable">-i</span> demo.flv <span class="token parameter variable">-c:a</span> copy <span class="token parameter variable">-c:v</span> copy <span class="token parameter variable">-f</span> flv rtmp://127.0.0.1:1935/live/test110<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="EasyDarwin"><a href="#EasyDarwin" class="headerlink" title="EasyDarwin"></a>EasyDarwin</h3><p> <a href="https://www.easydarwin.org/p/easydarwin.html">EasyDarwin</a>音视频流媒体服务器，支持视频点播、RTMP推流直播（RTSP、FLV、WebRTC）、串流拉流直播、服务端录像与回放、视频抽帧快照； </p><p>具体用法参照官网文档教程；</p><h3 id="GStreamer"><a href="#GStreamer" class="headerlink" title="GStreamer"></a>GStreamer</h3><p> <a href="https://gstreamer.freedesktop.org/">GStreamer</a> 是一个用于构造媒体处理组件图形的库。它支持的应用范围从简单的 Ogg&#x2F;Vorbis 播放、音频&#x2F;视频流到复杂的音频（混音）和视频（非线性编辑）处理。</p><p>具体用法可以看官方文档，或者看这位大佬写的教程 <a href="https://www.cnblogs.com/xleng/tag/gstreamer/">gstreamer - 教程 - John.Leng - 博客园 (cnblogs.com)</a> </p>]]></content>
      
      
      
        <tags>
            
            <tag> c++ </tag>
            
            <tag> 摄像头取流 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程数据传输</title>
      <link href="/2024/04/29/multi-thread-data-transfer/"/>
      <url>/2024/04/29/multi-thread-data-transfer/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在多线程开发任务中，不同线程之间的数据可以通过回调函数进行传输，如下例：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QThread</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        model<span class="token operator">-></span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模型初始化</span>        <span class="token comment">// 注册回调</span>        model<span class="token operator">-></span><span class="token function">registerCallback</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Base<span class="token double-colon punctuation">::</span>getModelResCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">imgSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 数据发送</span>        <span class="token function">resProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结果处理</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    cv<span class="token double-colon punctuation">::</span>Mat <span class="token function">getImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取待推理图像</span>    <span class="token keyword">void</span> <span class="token function">getModelResCallback</span><span class="token punctuation">(</span><span class="token keyword">int</span> inferRes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        imgInferRes<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>inferRes<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取回调结果</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">imgSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        cv<span class="token double-colon punctuation">::</span>Mat im <span class="token operator">=</span> <span class="token function">getImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        model<span class="token operator">-></span><span class="token function">addImg</span><span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">resProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> imgInferRes<span class="token punctuation">;</span>    Model <span class="token operator">*</span>model<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Model</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QThread</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模型初始化</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imgQueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                inferRes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">forward</span><span class="token punctuation">(</span>imgQueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                imgQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">addImg</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat m_img<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        imgQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>m_img<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">registerCallback</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">int</span> modelRes<span class="token punctuation">)</span><span class="token operator">></span> callback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        inferRes<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> callback<span class="token punctuation">;</span>        inferRes<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> inferRes<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> imgQueue<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当线程数量变多，处理逻辑变复杂之后，整个程序的耦合度较高，因为程序的处理逻辑为：Base —(data)—&gt; Model，Model —(res)—&gt; Base，Base—&gt;process(res)，这样一来一回一处理，在调试程序时想分模块检查时就会比较困难，而且一个操作不当就会发生容器竞争现象；</p><p>为了将程序逻辑改为：Base —(data)—&gt; Model —(res)—&gt; Process 这样的线性处理方式，可以采用生产者与消费者模式；生产者与消费者详细教程请参考：<a href="/2024/04/29/prodcons/" title="生产者消费者">生产者与消费者</a></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QThread</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        model<span class="token operator">-></span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">imgSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    Model <span class="token operator">*</span>model<span class="token punctuation">;</span>    cv<span class="token double-colon punctuation">::</span>Mat <span class="token function">getImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取待推理图像</span>    <span class="token keyword">void</span> <span class="token function">imgSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        cv<span class="token double-colon punctuation">::</span>Mat im <span class="token operator">=</span> <span class="token function">getImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        model<span class="token operator">-></span><span class="token function">addImg</span><span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Model</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QThread</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        process<span class="token operator">-></span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 后处理初始化</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imgQueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                process<span class="token operator">-></span><span class="token function">addInferRes</span><span class="token punctuation">(</span><span class="token function">forward</span><span class="token punctuation">(</span>imgQueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                imgQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">addImg</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat m_img<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>        imgQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>m_img<span class="token punctuation">)</span><span class="token punctuation">;</span>        cv<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    Process <span class="token operator">*</span>process<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> imgQueue<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Process</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QThread</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resQueue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">resProcess</span><span class="token punctuation">(</span>resQueue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                resQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">addInferRes</span><span class="token punctuation">(</span><span class="token keyword">int</span> inferRes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>        resQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>inferRes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">resProcess</span><span class="token punctuation">(</span><span class="token keyword">int</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> resQueue<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> c++ </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>生产者消费者</title>
      <link href="/2024/04/29/prodcons/"/>
      <url>/2024/04/29/prodcons/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>生产者与消费者模式个人理解主要用于不同线程之间的数据传输，可以将生产者看作一个线程P，消费者看作一个线程C，再加上一个数据容器D，生产者P不断向容器D里面生产数据，容器盛满时停止生产，消费者C不断从容器D里面消费数据，容器为空时停止消费；</p><p>命名约定：生产者Prod、消费者Cons、数据容器Data；</p><h3 id="基础模式"><a href="#基础模式" class="headerlink" title="基础模式"></a>基础模式</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;deque></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>std<span class="token double-colon punctuation">::</span>deque<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> dq<span class="token punctuation">;</span> <span class="token comment">// 数据容器Data</span>std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> max_length <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token comment">// 容器容量</span><span class="token comment">/* * Prod：当Data中数据满了时，Prod线程停止生产；当Data中没有数据或者没满时，Prod线程一直生产； */</span><span class="token keyword">void</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// 生产数据；</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 此处可以改为 while(i &lt; 100) 这样就不会无休止执行下去了；</span>        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 容器满就停止生产</span>        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> dq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> max_length<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Producing: "</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        dq<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 通知消费者线程，所有(notify_all)或单个(notify_one)；</span>        cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 模拟生产时间</span>        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 程序执行完后会自动解锁互斥，当然，也可以手动设置；</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/* * Cons：当Data中数据为空时，Cons线程停止消费；当Data中有数据时，Prod线程一直消费； */</span><span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 容器为空就停止消费</span>        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token operator">!</span>dq<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> data <span class="token operator">=</span> dq<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dq<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Consuming: "</span> <span class="token operator">&lt;&lt;</span> data <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        <span class="token comment">// 通知生产者线程</span>        cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 模拟消费时间</span>        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">Prod</span><span class="token punctuation">(</span>producer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生产者</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">Cons</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 消费者</span>    Prod<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Cons<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><p>上例基础模式为一个生产者对应一个消费者；除此之外还有：多个生产者对应一个消费者、一个生产者对应多个消费者、多个生产者对应多个消费者；在这些模式中，消费者如果想知道其中一条数据属于哪个生产者可以通过给每条数据加上生产者id来实现；</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;deque></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>std<span class="token double-colon punctuation">::</span>deque<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">>></span> dq<span class="token punctuation">;</span> <span class="token comment">// 数据容器Data</span>std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> max_length <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token comment">// 容器容量</span><span class="token keyword">bool</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                  <span class="token comment">// 用来标记Prod是否生产结束；</span><span class="token keyword">void</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 生产数据；</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> dq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> max_length<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> id <span class="token operator">&lt;&lt;</span> <span class="token string">" Producing: "</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        dq<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 数据送入容器中后就可以解锁互斥了</span>        cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 模拟生产时间</span>        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 创建互斥锁</span>    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>    done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>     <span class="token comment">// 生产者不再生产了，将标记置为true</span>    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 解锁互斥</span>    cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知消费者线程；</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 容器为空就停止消费，或者生产者不生产了</span>        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token operator">!</span>dq<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> done<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 当生产者不生产，且数据容器中没有数据时，消费者线程执行结束；</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dq<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">></span> data <span class="token operator">=</span> dq<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dq<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Consuming: id "</span> <span class="token operator">&lt;&lt;</span> data<span class="token punctuation">.</span>second <span class="token operator">&lt;&lt;</span> <span class="token string">" value "</span> <span class="token operator">&lt;&lt;</span> data<span class="token punctuation">.</span>first <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从容器中拿出数据后就可以解锁互斥了，将上面打印写在锁内是为了输出对齐；</span>        <span class="token comment">// 通知生产者线程</span>        cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 模拟消费时间</span>        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">Prod1</span><span class="token punctuation">(</span>producer<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     std<span class="token double-colon punctuation">::</span>thread <span class="token function">Prod2</span><span class="token punctuation">(</span>producer<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     std<span class="token double-colon punctuation">::</span>thread <span class="token function">Cons</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>         Prod1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Prod2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Cons<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="数据回传"><a href="#数据回传" class="headerlink" title="数据回传"></a>数据回传</h3><p>当消费者消费数据后，如果想将处理后的结果回传给对应的生产者，可以利用共享队列来实现；</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;deque></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span><span class="token comment">// 数据结构体</span><span class="token keyword">struct</span> <span class="token class-name">Data</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> value<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">></span> res<span class="token punctuation">;</span> <span class="token comment">// &lt;生产者id，value对应的结果></span>    <span class="token function">Data</span><span class="token punctuation">(</span><span class="token keyword">int</span> v<span class="token punctuation">)</span> <span class="token operator">:</span>        <span class="token function">value</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>deque<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">>></span> dq<span class="token punctuation">;</span> <span class="token comment">// 数据容器Data，其实这个队列就是共享队列，因为它是全局量；</span>std<span class="token double-colon punctuation">::</span>deque<span class="token operator">&lt;</span>Data<span class="token operator">></span> res_dq<span class="token punctuation">;</span>            <span class="token comment">// 结果容器Data；</span>std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> max_length <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token comment">// 容器容量</span><span class="token keyword">bool</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                  <span class="token comment">// 用来标记Prod是否生产结束；</span><span class="token keyword">void</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 生产数据；</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 容器满就停止生产</span>        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> dq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> max_length<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> id <span class="token operator">&lt;&lt;</span> <span class="token string">" Producing: "</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        dq<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 模拟生产时间</span>        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 创建互斥锁</span>    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>    done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 容器为空就停止消费，或者生产者不生产了</span>        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token operator">!</span>dq<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> done<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 当生产者不生产，且数据容器中没有数据时，消费者线程执行结束；</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dq<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">></span> data <span class="token operator">=</span> dq<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dq<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Consuming: id "</span> <span class="token operator">&lt;&lt;</span> data<span class="token punctuation">.</span>second <span class="token operator">&lt;&lt;</span> <span class="token string">" value "</span> <span class="token operator">&lt;&lt;</span> data<span class="token punctuation">.</span>first <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 通知生产者线程</span>        cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 模拟消费时间</span>        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 消费者处理数据并存储在另一个容器中，回传结果给生产者；</span>        <span class="token keyword">int</span> res <span class="token operator">=</span> data<span class="token punctuation">.</span>first <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>        Data <span class="token function">item</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>        item<span class="token punctuation">.</span>res <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>second<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>        res_dq<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">Prod1</span><span class="token punctuation">(</span>producer<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生产者</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">Prod2</span><span class="token punctuation">(</span>producer<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生产者</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">Cons</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 消费者</span>    Prod1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Prod2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Cons<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Ping-Pong模式"><a href="#Ping-Pong模式" class="headerlink" title="Ping-Pong模式"></a>Ping-Pong模式</h3><p>“ping-pong” 模式通常用于两个线程之间交替执行某个任务。在这个模式中，一个线程执行完毕后通知另一个线程开始执行，然后等待另一个线程执行完毕再继续，如此往复，就像乒乓球一样。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;deque></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>mutex m<span class="token punctuation">;</span><span class="token keyword">bool</span> ping <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 用来标记表示轮到哪个线程执行；</span><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 数据容器Data，用来记录 ping-pong 的次数；</span><span class="token keyword">void</span> <span class="token function">pinger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> ping<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Ping: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">++</span>count <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        ping <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">// ping 之后置为false，就该pong了；</span>        cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知pong线程</span>        <span class="token comment">// 模拟反应时间</span>        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">ponger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token operator">!</span>ping<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Pong: "</span> <span class="token operator">&lt;&lt;</span> count <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>        ping <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>     <span class="token comment">// pong 之后置为true，就该ping了；</span>        cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知ping线程</span>        <span class="token comment">// 模拟反应时间</span>        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">Ping</span><span class="token punctuation">(</span>pinger<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ping</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">Pong</span><span class="token punctuation">(</span>ponger<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pong</span>    Ping<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Pong<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>上面四例描述了生产者与消费者模式的基本操作流程，在实际应用中可以将producer()、consumer()方法封装为类，std::deque<int> dq 容器里面里面也可以传递对象来实现更复杂的业务流程；</p><p>此处部分内容来源于Mr.Q<i class="fas fa-rocket"></i>的指导，感谢Mr.Q<i class="fas fa-rocket"></i>！</p>]]></content>
      
      
      
        <tags>
            
            <tag> c++ </tag>
            
            <tag> 生产者与消费者 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xmake入门</title>
      <link href="/2024/04/26/xmake-start/"/>
      <url>/2024/04/26/xmake-start/</url>
      
        <content type="html"><![CDATA[<h3 id="xmake-常用命令"><a href="#xmake-常用命令" class="headerlink" title="xmake 常用命令"></a><code>xmake</code> 常用命令</h3><h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">xmake&#x2F;&#x2F; 编译程序xmake run&#x2F;&#x2F; 运行程序    xmake install -y&#x2F;&#x2F; 将当前编译好的程序安装到系统环境，默认位置&#x2F;user&#x2F;local下xmake uninstall -y&#x2F;&#x2F; 卸载安装程序；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="基本命令介绍"><a href="#基本命令介绍" class="headerlink" title="基本命令介绍"></a>基本命令介绍</h4><p><code>xmake --help</code></p> <img src="/2024/04/26/xmake-start/xmake_help.png" class="" title="xmake help"> <p>xmake命令行格式为：</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">xmake [task] [options] [target]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>[]</code> 表示可选输入，task为子命令任务名，options为参数选项，target指的是当前命令针对那些目标程序；</p><p>常用子命令：</p><ul><li><code>build</code>：程序构建；</li><li><code>clean</code>：删除编译过程中的所有二进制文件和临时文件；</li><li><code>config</code>：配置编译需要的参数，如平台、架构等，缩写用 <code>f</code> 表示；</li><li><code>global</code>：配置xmake的全局编译参数；</li><li><code>install</code>：安装编译后的目标程序；</li><li><code>package</code>：打包编译生成的库与头文件；</li><li><code>require</code>：手动拉取第三方依赖库；</li><li><code>run</code>：运行目标程序；</li><li><code>uninstall</code>：卸载目标程序；</li><li><code>update</code>：更新xmake；</li></ul><p>build子命令：</p><ul><li><code>-v/--verbose</code>：查看详细完整的编译命令。</li><li><code>-r/--rebuild</code>：强制重新编译所有代码。</li><li><code>-j/--jobs</code>：指定多任务编译的并行任务数。</li><li><code>-w/--warning</code>：编译过程中显示编译警告信息。</li></ul><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">xmake -rv&#x2F;&#x2F; 查看详细编译选项xmake f -m debug&#x2F;&#x2F; 切换到debug模式、也可以切换release、releasedbg模式xmake f -o &#x2F;out&#x2F;&#x2F; 切换编译输出目录xmake f -v&#x2F;&#x2F; 查看当前的配置信息&#x2F;&#x2F; --cflags 仅仅添加 C 编译选项，--cxxflags 为仅仅添加 C++ 编译选项，--cxflags 同时添加 C&#x2F;C++ 编译选项。xmake f --cxflags&#x3D;&quot;-DTEST&quot;&#x2F;&#x2F; 仅仅添加C编译选项&#x2F;&#x2F; 添加链接库和搜索路径xmake f --ldflags&#x3D;&quot;-L&#x2F;tmp -lpthread&quot;&#x2F;&#x2F; 表示新增 &#x2F;tmp 的库搜索目录，并添加额外的 pthread 链接库xmake f --links&#x3D;&quot;pthread&quot; --linkdirs&#x3D;&quot;&#x2F;tmp&quot; &#x2F;&#x2F; 与上面一行效果一样xmake f --toolchain&#x3D;clang &#x2F;&#x2F; 切换到 clang 编译器，前提是安装了clang xmake f -c&#x2F;&#x2F; 重置所有配置     xmake update -f&#x2F;&#x2F; xmake更新到最新版本<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>xmake show</code> 显示的信息含义</p> <img src="/2024/04/26/xmake-start/xmake_show.png" class="" title="xmake show"> <h4 id="xmake-lua基础配置"><a href="#xmake-lua基础配置" class="headerlink" title="xmake.lua基础配置"></a>xmake.lua基础配置</h4><ul><li><code>set_kind</code> ：设置目标类型；phony 空目标程序、binary 二进制程序、static 静态库程序、shard 动态库程序；</li><li><code>add_cxflags</code> ：添加 C&#x2F;C++ 编译选项；</li><li><code>add_defines</code> ：添加宏定义；</li><li><code>add_includedirs</code>：添加头文件搜索目录；</li><li><code>add_linkdirs</code>：添加库搜索目录；</li><li><code>add_links</code>：添加链接库；</li><li><code>add_syslinks</code>：添加系统链接库；</li><li><code>set_languages</code> ：设置语言标准；</li><li><code>add_files</code> ：添加源文件；中间用 <code>|</code> 分割表示过滤的文件；</li><li><code>add_requires()</code> ：指定当前项目需要哪些包，编译时候会触发一次依赖包的安装；</li><li><code>add_packages()</code> ：配置对特定 target 目标集成指定的依赖包，需要与 <code>add_requires()</code> 配合使用，二者缺一不可。</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> xmake </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LeetCode-二叉树</title>
      <link href="/2024/03/25/leetcode-study-binarytree/"/>
      <url>/2024/03/25/leetcode-study-binarytree/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>定义一个二叉树</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TreeNode</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> val<span class="token punctuation">;</span>    <span class="token class-name">TreeNode</span> left<span class="token punctuation">;</span>    <span class="token class-name">TreeNode</span> right<span class="token punctuation">;</span>    <span class="token class-name">TreeNode</span> next<span class="token punctuation">;</span>    <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> left<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> left<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> right<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> _val<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> _left<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> _right<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> _next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        val <span class="token operator">=</span> _val<span class="token punctuation">;</span>        left <span class="token operator">=</span> _left<span class="token punctuation">;</span>        right <span class="token operator">=</span> _right<span class="token punctuation">;</span>        next <span class="token operator">=</span> _next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="一、二叉树遍历"><a href="#一、二叉树遍历" class="headerlink" title="一、二叉树遍历"></a>一、二叉树遍历</h1><h2 id="1-前序遍历"><a href="#1-前序遍历" class="headerlink" title="1. 前序遍历"></a>1. 前序遍历</h2><p>前序遍历首先访问根节点，然后遍历左子树，最后遍历右子树。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreorderTraversal</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> ans<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">preorderTraversal</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/*     * 递归实现二叉树前序遍历。     * 递归终止条件：当前根为空，返回空；     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 前序遍历非递归实现.     */</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">preorderTraversal1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点为空，直接返回</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> ans<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 创建栈</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//根节点复制一份传给node, node表示当前节点</span>        <span class="token class-name">TreeNode</span> node <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token comment">// 当栈不为空或者node不为空时，继续循环</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> node <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 当前节点不为空时，继续从左子树向下循环</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                node <span class="token operator">=</span> node<span class="token punctuation">.</span>left<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            node <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            node <span class="token operator">=</span> node<span class="token punctuation">.</span>right<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Deque.pop()：从此双端队列所表示的堆栈中弹出一个元素。</li><li>Deque.push()：将一个元素推入此双端队列表示的栈中，即从此双端队列的头部添加元素。</li></ul><h2 id="2-中序遍历"><a href="#2-中序遍历" class="headerlink" title="2. 中序遍历"></a>2. 中序遍历</h2><p>中序遍历是先遍历左子树，然后访问根节点，然后遍历右子树。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InorderTraversal</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> ans<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">inorderTraversal</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">inorderTraversal1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 空树判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> ans<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 利用双端队列创建一个栈</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> node <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token comment">// 栈不为空或节点不为空则继续循环。</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> node <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 节点入栈</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 向左走，当没有左子树时跳出循环。</span>                node <span class="token operator">=</span> node<span class="token punctuation">.</span>left<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            node <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>            node <span class="token operator">=</span> node<span class="token punctuation">.</span>right<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-后序遍历"><a href="#3-后序遍历" class="headerlink" title="3. 后序遍历"></a>3. 后序遍历</h2><p>后序遍历是先遍历左子树，然后遍历右子树，最后访问树的根节点。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostorderTraversal</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> ans<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">postorderTraversal</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 后序遍历非递归实现.     */</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">postorderTraversal1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 1. 每拿到一个节点，就把它保存在栈中         * 2. 继续对这个节点的左子树重复过程1，直到左子树为空         * 3. 因为保存在栈中的节点都遍历了左子树但是没有遍历右子树，所以对栈中节点出栈，并对它的右子树重复过程1直到遍历完所有节点         */</span>        ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点为空，直接返回</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> ans<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 创建栈</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//根节点复制一份传给node, node表示当前节点</span>        <span class="token class-name">TreeNode</span> node <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token comment">// 当栈不为空或者node不为空时，继续循环</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> root <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 当前节点不为空时，继续从左子树向下循环</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>root <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>                root <span class="token operator">=</span> root<span class="token punctuation">.</span>left<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 将最左边的节点取出来，然后判断它有没有右子树，以及</span>            root <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>right <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> root<span class="token punctuation">.</span>right <span class="token operator">==</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>                node <span class="token operator">=</span> root<span class="token punctuation">;</span>                root <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>                root <span class="token operator">=</span> root<span class="token punctuation">.</span>right<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-层序遍历"><a href="#4-层序遍历" class="headerlink" title="4. 层序遍历"></a>4. 层序遍历</h2><p>即逐层地，从左到右访问所有节点。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LevelOrderTraversal</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ans<span class="token punctuation">;</span>    <span class="token comment">/**     * 递归思路，BFS     */</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">levelOrder</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/*     * 递归的思路，核心是在每次往下走一层时，往list中加入一个初始化的列表，然后在遍历到哪一层时，将它对应的值加入到它对应的层中。     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ans<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 边界条件判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// level代表层数，如果 level >= list.size()，说明到下一层了，所以要先把下一层的list初始化，防止下面的add的时候空指针异常。</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">>=</span> ans<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// level并表示的是第几层，这里访问到第几层，就把数据加入到第几层</span>        ans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 当前节点访问完之后，在使用递归的方式分别访问当前节点的左右子节点。</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 层级遍历非递归思路，利用队列。     */</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">levelOrder1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点为空直接返回</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> ans<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">/*         * 思路：根节点先入队。然后循环1-3直到队列为空。         * 1. 节点出队。         * 2. 节点的左子树入队。         * 3. 节点的右子树入队。         */</span>        <span class="token comment">// 创建一个队列进行存储节点数据。</span>        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点入队列</span>        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 此列表存储每一层的数据</span>            <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> level <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 每一层的数据个数</span>            <span class="token keyword">int</span> levelCount <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> levelCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 节点出队</span>                <span class="token class-name">TreeNode</span> node <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 左节点入队</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// 右节点入队</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                level<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="二、运用递归解决问题"><a href="#二、运用递归解决问题" class="headerlink" title="二、运用递归解决问题"></a>二、运用递归解决问题</h1><h2 id="1-二叉树的最大深度"><a href="#1-二叉树的最大深度" class="headerlink" title="1. 二叉树的最大深度"></a>1. 二叉树的最大深度</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MaxDepth</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/*     * 1. DFS：深度优先搜索算法。对于树而言，就相当于沿着树的深度遍历树的节点，尽可能深的搜索树的分支，直到所有节点遍历完，     * 2. BFS：广度优先搜索算法。对于树而言，相当于层序遍历，有多少层，则最大深度就是几。     */</span>    <span class="token comment">/**     * DFS递归实现，     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">maxDepthDFSRecursion</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 每个节点的深度与它的左右子树的深度有关，等于其左右子树最大深度加1；         * 那么将求根节点的最大深度划分为求它的的左右子树的最大深度，以此类推；         * 当当前节点为空时，那么递归终止，返回0；         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 获取左子树的深度</span>            <span class="token keyword">int</span> leftHeight <span class="token operator">=</span> <span class="token function">maxDepthDFSRecursion</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 获取右子树的深度</span>            <span class="token keyword">int</span> rightHeight <span class="token operator">=</span> <span class="token function">maxDepthDFSRecursion</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 返回其左右子树最大深度加1</span>            <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>leftHeight<span class="token punctuation">,</span> rightHeight<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/*     * 当树非常深时，栈会发生由于保存过多的临时变量而溢出。事实上，函数调用的参数是通过栈空间来传递的，在调用过程中会占用线程的栈资源。     * 而递归调用，只有走到最后的结束点后函数才能依次退出，而未到达最后的结束点之前，占用的栈空间一直没有释放，     * 如果递归调用次数过多，就可能导致占用的栈资源超过线程的最大值，从而导致栈溢出，导致程序的异常退出。     * 99%的递归转非递归，都可以通过栈来进行实现。     */</span>    <span class="token comment">/**     * DFS非递归实现，利用栈.     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">maxDepthDFSNonRecursion</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 利用深度优先算法遍历二叉树，同时求得最大深度。         * 深度优先遍历又分为：前序、中序、后序；         * 此处用深度前序遍历二叉树，添加一个层数栈，来记录每个节点所处的位置         * 层数栈的值与节点栈一一对应，同入同出         */</span>        <span class="token comment">// 记录二叉树的最大深度</span>        <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> max<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 节点栈</span>        <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> nodeStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 节点层数栈</span>        <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> levelStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        nodeStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        levelStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>nodeStack<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 弹出节点与其对应的层数</span>            <span class="token class-name">TreeNode</span> curNode <span class="token operator">=</span> nodeStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> curNodelevel <span class="token operator">=</span> levelStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 记录最大层数</span>            max <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>max<span class="token punctuation">,</span> curNodelevel<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 因为是前序遍历（根-左-右），所以右子树先入栈。</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                nodeStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                levelStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>curNodelevel <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                nodeStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                levelStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>curNodelevel <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> max<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * BFS递归实现     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">maxDepthBFS</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 二叉树层序遍历的递归法，最后返回遍历列表的size即可。         */</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ans<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 边界条件判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// level代表层数，如果 level >= list.size()，说明到下一层了，所以要先把下一层的list初始化，防止下面的add的时候空指针异常。</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">>=</span> ans<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// level并表示的是第几层，这里访问到第几层，就把数据加入到第几层</span>        ans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 当前节点访问完之后，在使用递归的方式分别访问当前节点的左右子节点。</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * BFS非递归实现，利用队列.     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">maxDepthBFSNonRecursion</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 层序遍历：根节点先入队，然后循环1~3至队列为空         * 1. 节点出队         * 2. 节点的左子树入队         * 3. 节点的右子树入队         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> outNode <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token comment">// count 记录二叉树的深度</span>        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 记录每一层节点的个数；</span>            <span class="token keyword">int</span> levelCount <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// outNode为栈队列出队的节点</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> levelCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                outNode <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>outNode<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>outNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            count<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> count<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-对称二叉树"><a href="#2-对称二叉树" class="headerlink" title="2. 对称二叉树"></a>2. 对称二叉树</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IsSymmetric</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 递归法     */</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSymmetric3</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 将两个树的对称问题理解为：它们的根节点具有相同的值，且每个树的右子树都与另一个树的左子树镜像对称。         * 方法：定义两个指针，p指针与q指针，两个指针初始化指向树的根节点，         * 然后p右移时，q左移；p左移时，q右移；         * 每次移动时检查指针指向的节点的值是否相等，若相等，再向下移。         */</span>        <span class="token keyword">return</span> <span class="token function">dfs3</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dfs3</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> p<span class="token punctuation">,</span><span class="token class-name">TreeNode</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> q <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> q <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> p<span class="token punctuation">.</span>val <span class="token operator">==</span> q<span class="token punctuation">.</span>val <span class="token operator">&amp;&amp;</span> <span class="token function">dfs3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>left<span class="token punctuation">,</span>q<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dfs3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>right<span class="token punctuation">,</span>q<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 非递归法     */</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSymmetric4</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 创建一个队列，将左右子树放入队列中，每次出队两个节点，只要每次都一样，那么就是true         * 初始化队列时根节点入队两次，当队列为空时，树遍历完了         */</span>        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> nodeQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点入队两次</span>        nodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        nodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>nodeQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token class-name">TreeNode</span> leftNode <span class="token operator">=</span> nodeQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">TreeNode</span> rightNode <span class="token operator">=</span> nodeQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>leftNode <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>leftNode <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rightNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> leftNode<span class="token punctuation">.</span>val <span class="token operator">!=</span> rightNode<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            nodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leftNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            nodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rightNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            nodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leftNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            nodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rightNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/*      自己写的      */</span>    <span class="token comment">/**     * 递归法     */</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSymmetric1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 一个列表存储根节点的左子树，存储顺序：根-左-右         * 一个列表存储根节点的右子树，存储顺序：根-右-左         * 并且当当前节点没有左右子树时，用一个符号“101”进行标记存储到列表中去，相当于“占位置”         */</span>        <span class="token comment">// 边界判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 存储根节点的左子树列表</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> leftSubtree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 存储根节点的左子树</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> rightSubtree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs1</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> leftSubtree<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs2</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> rightSubtree<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 若两个列表长度不同，则直接返回false</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leftSubtree<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> rightSubtree<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 若相同，则循环遍历，当有不同的值时，返回false，完全相同则返回true</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> leftSubtree<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>leftSubtree<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">!=</span> rightSubtree<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dfs1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> leftSubTree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            leftSubTree<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            leftSubTree<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">dfs1</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> leftSubTree<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">dfs1</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> leftSubTree<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dfs2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> rightSubTree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            rightSubTree<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            rightSubTree<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">dfs2</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> rightSubTree<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">dfs2</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> rightSubTree<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 非递归法     */</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSymmetric2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 从根节点将儿叉树分为左子树与右子树，然后对这两个子树进行遍历，若果每次遍历的值都相同，那么最终返回true，否则返回false         * 左子树遍历规则：根-左-右；右子树遍历规则：根-右-左         * 用两个队列来存储每次遍历的值         */</span>        <span class="token comment">// 边界判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 将根节点分为左右子树</span>        <span class="token class-name">TreeNode</span> leftSubtreeNode <span class="token operator">=</span> root<span class="token punctuation">.</span>left<span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> rightSubtreeNode <span class="token operator">=</span> root<span class="token punctuation">.</span>right<span class="token punctuation">;</span>        <span class="token comment">// 当左右子树都为空时，返回true</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leftSubtreeNode <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 创建左右子树队列</span>        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> leftSubtreeNodeQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> rightSubtreeNodeQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        leftSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">)</span><span class="token punctuation">;</span>        rightSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rightSubtreeNode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 当其中一个子树为空，另一个不为空时，返回false</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>leftSubtreeNode <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span>                <span class="token punctuation">(</span>leftSubtreeNode <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>leftSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>rightSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            leftSubtreeNode <span class="token operator">=</span> leftSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            rightSubtreeNode <span class="token operator">=</span> rightSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 节点出队，判断节点值是否相等，若不相等，则直接返回false</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">.</span>val <span class="token operator">==</span> rightSubtreeNode<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 按照遍历顺序往队列中添加节点，当其中一个节点为空，另一个不为空时，返回false</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    leftSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                    rightSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rightSubtreeNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNode<span class="token punctuation">.</span>right <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span>                        <span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">.</span>left <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNode<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    leftSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                    rightSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rightSubtreeNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNode<span class="token punctuation">.</span>left <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span>                        <span class="token punctuation">(</span>leftSubtreeNode<span class="token punctuation">.</span>right <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNode<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 当其中一个队列为空，另一个不为空时，返回false</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>leftSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rightSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>                    <span class="token punctuation">(</span>leftSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>rightSubtreeNodeQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-路径总和"><a href="#3-路径总和" class="headerlink" title="3. 路径总和"></a>3. 路径总和</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HasPathSum</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 112. 路径总和     */</span>    <span class="token comment">/**     * 递归法     */</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPathSum1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span> targetSum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 遍历二叉树，定义一个curTarget表示targetSum减去路径上每个节点的值后剩余的值，curTarget初始化为targetSum         * 子问题为，当到root.right或root.left时，targetSum = targetSum - root.val;         * 这样依次往下，当节点为null时，返回false，当递归到某个叶子节点(左右子树都为null)时且当前节点的val == targetSum时，返回true。         * 每次的返回结果进行或运算，有一个true则说明有存在值相加等于targetSum的路径。         */</span>        <span class="token comment">// 当前节点为null时，返回false</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 判断当前节点是否是叶子节点，若是则判断值是否相等</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>left <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span>right <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">.</span>val <span class="token operator">==</span> targetSum<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token function">hasPathSum1</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> targetSum <span class="token operator">-</span> root<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasPathSum1</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> targetSum <span class="token operator">-</span> root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 迭代法     */</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPathSum2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span> targetSum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 利用两个队列，一个队列存当前节点，一个队列存根节点到当前节点值的和，用BFS遍历法进行遍历求解         * 每次节点值和节点一块出队列时，然后进行一个判断，如果当前节点为叶子节点，那么就比对一下targetSum与当前路径上的和是否相等，然后返回         */</span>        <span class="token comment">// 边界处理</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 定义两个队列</span>        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> nodeQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> pathSumQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/*         * 同样是往列表结尾添加元素，LinkedList中add()与offer()的区别：         * offer 方法 调用的就是 add 方法         * offer 实现 Deque 接口的方法，add 实现 Collection 接口方法         * 作为List使用时,一般采用add / get方法来 加入/获取对象         * 作为Queue使用时,才会采用 offer/poll/take等方法         */</span>        nodeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        pathSumQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>nodeQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token class-name">TreeNode</span> curNode <span class="token operator">=</span> nodeQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> curPathSum <span class="token operator">=</span> pathSumQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 判断是不是叶子节点，如果是，则进行比对</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> curNode<span class="token punctuation">.</span>right <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>curPathSum <span class="token operator">==</span> targetSum<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                nodeQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                pathSumQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>curPathSum<span class="token operator">+</span>curNode<span class="token punctuation">.</span>left<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                nodeQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                pathSumQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>curPathSum<span class="token operator">+</span>curNode<span class="token punctuation">.</span>right<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><h2 id="1-从前序与中序遍历序列构造二叉树"><a href="#1-从前序与中序遍历序列构造二叉树" class="headerlink" title="1. 从前序与中序遍历序列构造二叉树"></a>1. 从前序与中序遍历序列构造二叉树</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreorderAndInorderBuildTree</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 105. 从前序与中序遍历序列构造二叉树     */</span>    <span class="token comment">// 创建成员变量，方便调用</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> post_idx<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> idx_map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 递归法     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">preorderAndInorderBuildTreeq1</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 前序遍历：根 -> 左 -> 右         * 中序遍历：左 -> 根 -> 右         * 与 106 题类似的思想         * 前序遍历数组的第一个元素便是二叉树的根节点，所以根据根节点在中序遍历数组中的位置，可以将中序数组分为左右子树         * 算法思路：首先创建一个哈希表存储中序遍历数组的元素与下标 &lt;数组元素，数组下标>         *         定义一个递归函数 helper(in_left, in_right) 表示当前子树的边界，in_right 初始化为 inorder.length - 1         *         如果 in_left > in_right 表示当前子树为空，返回空；         *         然后根据哈希表返回前序遍历数组中当前根节点元素在中序遍历数组中的位置下标 index ；         *         根据 index 得到左子树 (in_left, index-1) ，右子树 (index+1, in_right)         *         然后再继续递归遍历，此处要先生成左子树，在生成右子树，因为前序遍历是：根 -> 左 -> 右         *         */</span>        <span class="token comment">// 初始化</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>preorder <span class="token operator">=</span> preorder<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>inorder <span class="token operator">=</span> inorder<span class="token punctuation">;</span>        post_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 将中序遍历数组元素存入 idx_map</span>        <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> val <span class="token operator">:</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            idx_map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> idx<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token function">helper</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inorder<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token class-name">TreeNode</span> <span class="token function">helper</span><span class="token punctuation">(</span><span class="token keyword">int</span> in_left<span class="token punctuation">,</span> <span class="token keyword">int</span> in_right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 如果 in_left > in_right 说明当前子树为空，返回空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>in_left <span class="token operator">></span> in_right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 获取根结点的值，并建立根节点</span>        <span class="token keyword">int</span> root_val <span class="token operator">=</span> preorder<span class="token punctuation">[</span>post_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>root_val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点向右移动一位</span>        post_idx<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token comment">// 获取根节点在中序遍历数组中的 index</span>        <span class="token keyword">int</span> index <span class="token operator">=</span> idx_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>root_val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 递归建立左右子树，先创建左子树，在创建右子树</span>        root<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token function">helper</span><span class="token punctuation">(</span>in_left<span class="token punctuation">,</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        root<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token function">helper</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> in_right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 迭代法     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">preorderAndInorderBuildTreeq2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 用一个栈来辅助完成树的建立。         * 思路：前序遍历数组中任意两个节点 u 和 v，他们之间的关系只有两种：         * 1. v 是 u 的左儿子；         * 2. u 没有左儿子，那么 v 将是 u 的祖先节点右儿子或者是 u 的左儿子，如果 u 没有右儿子，那么就向上回溯，         * 因为前序遍历是：根 -> 左 -> 右，中序遍历是：左 -> 根 -> 右，         * 那么将前序遍历数组入栈，入栈时判断栈顶元素与中序遍历数组当前值是否相同，         * 若不相同，则证明当前节点还有左儿子，则当前前序遍历数组节点入栈继续判断         * 若相同，则证明当前前序遍历数组的节点已经没有左儿子了，下一个前序遍历数组元素不是当前节点的右儿子，就是其祖先节点的右儿子         * 那么然后开始出栈，出栈条件：当栈不为空且栈顶元素节点值 == 中序遍历数组当前值时，出栈；每出一个中序遍历数组元素向右移一位；         * 出栈是为了找到前序遍历数组的下一个元素的父节点。         * 出完后，将前序遍历数组的下一个元素，作为当前节点的右儿子，然后入栈。         * 循环遍历。         */</span>        <span class="token comment">// 边界判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>preorder<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> preorder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 因为前序遍历数组第一个节点为根节点，所以先创建树的根节点</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorder<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 创建一个栈</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点入栈</span>        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 创建一个变量表示中序数组的下标</span>        <span class="token keyword">int</span> inorderIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> preorder<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 获取前序遍历数组当前的值</span>            <span class="token keyword">int</span> preorderVal <span class="token operator">=</span> preorder<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment">// 获取当前节点</span>            <span class="token class-name">TreeNode</span> node <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 判断当前节点的值与当前中序遍历数组的值是否相等</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>val <span class="token operator">!=</span> inorder<span class="token punctuation">[</span>inorderIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 若不相等，则表明当前的 preorderVal 是当前节点的左儿子，那么将其创建并入栈</span>                node<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorderVal<span class="token punctuation">)</span><span class="token punctuation">;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 若不想等，则证明当前的 preorderVal 不是当前节点的左儿子了，那么 preorderVal 要么是当前节点的右儿子，要么是当前节点祖先的右儿子</span>                <span class="token comment">// 寻找 preorderVal 的父节点</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>val <span class="token operator">==</span> inorder<span class="token punctuation">[</span>inorderIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">// 向上回溯当前节点的祖先节点</span>                    node <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    inorderIndex<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                node<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorderVal<span class="token punctuation">)</span><span class="token punctuation">;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 递归法     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">preorderAndInorderBuildTreeq3</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 思路大致与 preorderAndInorderBuildTreeq1 一致。         * 前序遍历：[根节点，[左子树的前序遍历结果]，[右子树的前序遍历结果]]         * 中序遍历：[[左子树的中序遍历结果]，根节点，[右子树的中序遍历结果]]         * 核心思想：左子树中序遍历的节点数等于前序遍历的节点数。         * 定义一个集合，存储中序遍历数组 &lt;数组元素，数组下标>，         * 定义一个函数 myBuildTree 传入参数：前序数组，中序数组，前序数组开始位置，前序数组结束位置，中序数组开始位置，中序数组结束位置         * 这样可以将左右子树当做一个完整的树传入 myBuildTree 中，递归建立树         */</span>        <span class="token comment">// 获取数组长度</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> preorder<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">// 定义下标</span>        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 中序数组存入集合</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> val <span class="token operator">:</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            idx_map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span>preorder<span class="token punctuation">,</span> inorder<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token class-name">TreeNode</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">,</span> <span class="token keyword">int</span> preorder_left<span class="token punctuation">,</span> <span class="token keyword">int</span> preorder_right<span class="token punctuation">,</span> <span class="token keyword">int</span> inorder_left<span class="token punctuation">,</span> <span class="token keyword">int</span> inorder_right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>preorder_left <span class="token operator">></span> preorder_right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 前序遍历数组的第一个节点就是根节点</span>        <span class="token keyword">int</span> preorder_root_val <span class="token operator">=</span> preorder<span class="token punctuation">[</span>preorder_left<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 创建根节点</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorder_root_val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 获取根节点在中序数组中的位置</span>        <span class="token keyword">int</span> inorder_root_index <span class="token operator">=</span> idx_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>preorder_root_val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 得到左子树的节点的数目</span>        <span class="token keyword">int</span> size_left_subtree <span class="token operator">=</span> inorder_root_index <span class="token operator">-</span> inorder_left<span class="token punctuation">;</span>        <span class="token comment">// 前序遍历左子树位置：[preorder_left+1, preorder_left+size_left_subtree] 对应中序中的左子树位置[inorder_left, inorder_root_index-1]</span>        root<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span>preorder<span class="token punctuation">,</span> inorder<span class="token punctuation">,</span> preorder_left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> preorder_left <span class="token operator">+</span> size_left_subtree<span class="token punctuation">,</span> inorder_left<span class="token punctuation">,</span> inorder_root_index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 前序遍历右子树位置：[preorder_left+size_left_subtree+1, preorder_right 对应中序中的右子树位置[inorder_root_index+1, inorder_right]</span>        root<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span>preorder<span class="token punctuation">,</span> inorder<span class="token punctuation">,</span> preorder_left <span class="token operator">+</span> size_left_subtree <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> preorder_right<span class="token punctuation">,</span> inorder_root_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> inorder_right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-从中序与后序遍历序列构造二叉树"><a href="#2-从中序与后序遍历序列构造二叉树" class="headerlink" title="2. 从中序与后序遍历序列构造二叉树"></a>2. 从中序与后序遍历序列构造二叉树</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InorderAndPostorderBuildTree</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 106. 从中序与后序遍历序列构造二叉树     */</span>    <span class="token comment">// 创建一些成员变量，方便调用</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> post_idx<span class="token punctuation">;</span> <span class="token comment">// 表示树的根节点</span>    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">;</span> <span class="token comment">// 中序遍历的数组</span>    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postorder<span class="token punctuation">;</span> <span class="token comment">// 后序遍历的数组</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> idx_map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 递归法     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">inorderAndPostorderBuildTree1</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 树的中序遍历：左 -> 根 -> 右         * 树的后序遍历：左 -> 右 -> 根         * 规律：后序数组的最后一个元素即为根节点。那就可以根据后续数组的最后一个元素将中序数组分成[左子树数组]，[根节点]，[右子树数组]         * 然后再将左子树数组，与右子树数组再按照上面的方法继续递归的划分下去，直到最终出现了叶节点。         * 算法过程：首先定义一个哈希表来存储 &lt;数组元素，数组下标>         *         定义一个递归函数 helper(in_left, in_right) 表示当前递归到中序序列中当前子树的边界，递归入口为 helper(0, n-1)         *         如果 in_left > in_right 说明子树为空，返回空节点；         *         选择后序遍历的最后一个节点作为根节点；         *         然后通过哈希表查到根节点 index ，从 in_left 到 index-1 为左子树，从 index+1 到 in_right 为右子树；         *         根据后序遍历的规律：递归创建右子树 helper(index+1, in_right)，然后再递归创建左子树 helper(in_left, index-1);         *         因为后序是左右根，所以逆向创建时也应该是先创建右子树，在创建左子树。         */</span>        <span class="token comment">// 成员属性初始化</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>inorder <span class="token operator">=</span> inorder<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>postorder <span class="token operator">=</span> postorder<span class="token punctuation">;</span>        <span class="token comment">// 从后序遍历数组的最后一个元素开始</span>        post_idx <span class="token operator">=</span> postorder<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">// 定义一个idx表示中序数组的下标</span>        <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 将中序数组元素存入哈希表中</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> val <span class="token operator">:</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            idx_map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> idx<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token function">helper</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inorder<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token class-name">TreeNode</span> <span class="token function">helper</span><span class="token punctuation">(</span><span class="token keyword">int</span> in_left<span class="token punctuation">,</span> <span class="token keyword">int</span> in_right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// in_left > in_right 说明子树为空，返回空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>in_left <span class="token operator">></span> in_right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 选择后序数组中 post_idx 的位置的元素作为当前子树的根节点</span>        <span class="token keyword">int</span> root_val <span class="token operator">=</span> postorder<span class="token punctuation">[</span>post_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>root_val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根据中序数组中 root 值所在的位置将数组分成两棵左右子树</span>        <span class="token keyword">int</span> index <span class="token operator">=</span> idx_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>root_val<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点下标减一</span>        post_idx<span class="token operator">--</span><span class="token punctuation">;</span>        <span class="token comment">// 构建右子树</span>        root<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token function">helper</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> in_right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 构建左子树</span>        root<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token function">helper</span><span class="token punctuation">(</span>in_left<span class="token punctuation">,</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 迭代法     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">inorderAndPostorderBuildTree2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postorder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 用一个栈来辅助完成树的建立。         * 后序遍历是：[左 -> 右 -> 根]         * 中序遍历是：[左 -> 根 -> 右]         * 对后序遍历数组从右往左入栈，那么入栈的节点将是：二叉树的根节点，根节点的右儿子，右儿子的右儿子，依次往下，[根->右儿子->右儿子……]。方向是从根向叶的         * 而中序遍历从右往左看的话，那么将是：右节点，右节点的父节点，父节点的父节点，一直到根节点，依次往上，[右儿子->父节点……->根节点]。方向是从叶到根         * 后序数组是从右向左开始入栈的，那么当入栈到二叉树的最右边的右子节点时，此时出栈的顺序将与中序数组从右往左的顺序是相同的         * 遍历后序数组，从右边第二个元素开始往左遍历，入栈时进行判断，判断条件：当前栈顶节点的值是否等于当前中序遍历数组的值         * 若不等于：当前后续数组元素为当前节点的右儿子，然后入栈；         * 若等于：则证明当前节点没有右儿子了，那么就要找出当前前序数组元素是属于当前节点的左儿子还是属于当前节点他祖先的左儿子；         */</span>        <span class="token comment">// 边界处理</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>postorder<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> postorder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 获取根节点</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>postorder<span class="token punctuation">[</span>postorder<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 创建一个栈</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点入栈</span>        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> inorderIndex <span class="token operator">=</span> inorder<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> postorder<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 获取当前后序数组遍历的值</span>            <span class="token keyword">int</span> postorderVal <span class="token operator">=</span> postorder<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment">// 获取当前头结点</span>            <span class="token class-name">TreeNode</span> node <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>val <span class="token operator">!=</span> inorder<span class="token punctuation">[</span>inorderIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                node<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>postorderVal<span class="token punctuation">)</span><span class="token punctuation">;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>val <span class="token operator">==</span> inorder<span class="token punctuation">[</span>inorderIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    node <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    inorderIndex<span class="token operator">--</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                node<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>postorderVal<span class="token punctuation">)</span><span class="token punctuation">;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-填充每个节点的下一个右侧节点指针"><a href="#3-填充每个节点的下一个右侧节点指针" class="headerlink" title="3. 填充每个节点的下一个右侧节点指针"></a>3. 填充每个节点的下一个右侧节点指针</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectRightNode</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 116. 填充每个节点的下一个右侧节点指针     */</span>    <span class="token comment">/**     * 层序遍历、队列     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">connect1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 层序遍历         * 利用队列，题目是要求二叉树的每一层的节点都连接起来形成一个链表。         * 每次出队节点的 next 指向队首的节点。         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 创建一个队列</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> deque <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点入队</span>        deque<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>deque<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 得到每一层节点的个数</span>            <span class="token keyword">int</span> size <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 一层出队，每个节点左右子节点入队。</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 从队首取出元素</span>                <span class="token class-name">TreeNode</span> node <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 将每次出对的节点都连接起来</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    node<span class="token punctuation">.</span>next <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// 出队节点的左右子节点入队</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    deque<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    deque<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 层序遍历、原地操作     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">connect2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 原地操作         * 使用已有的 next 指针，假设二叉树有 N 层，每次的 N-1 层，处理第 N 层的节点         * 你想想：下一层的节点无非就两种关系，一是同一个父节点，二是不同父节点；         * 对于同一个父节点：node.left.next = node.right;         * 对于不同一个父节点的两个节点，若他们两个有关系，那么它们的父节点一定是：一个是一个的下一个节点         * 那么就会有：node.right.next = node.next.left         * 每一层按照上述方法，一直到倒数第二层。         */</span>        <span class="token comment">// 边界处理</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 从根节点开始，一层一层往下处理，leftmost作为第N-1层节点的头节点，再一个就是用来判断是否到达最后一层</span>        <span class="token class-name">TreeNode</span> leftmost <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token comment">// 当到最后一层时，终止循环</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>leftmost<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 头结点复制一份，免得后面头节点的改变导致链表发生变化。</span>            <span class="token class-name">TreeNode</span> head <span class="token operator">=</span> leftmost<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>head <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 同一个父节点</span>                head<span class="token punctuation">.</span>left<span class="token punctuation">.</span>next <span class="token operator">=</span> head<span class="token punctuation">.</span>right<span class="token punctuation">;</span>                <span class="token comment">// 不同父节点</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    head<span class="token punctuation">.</span>right<span class="token punctuation">.</span>next <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">.</span>left<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                head <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            leftmost <span class="token operator">=</span> leftmost<span class="token punctuation">.</span>left<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token comment">/**     * 递归法     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">connect3</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 递归法         * 思路：         * 终止条件：当前节点为空时         * 递归体：         */</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">TreeNode</span> nodeLeft <span class="token operator">=</span> root<span class="token punctuation">.</span>left<span class="token punctuation">;</span>        <span class="token class-name">TreeNode</span> nodeRight <span class="token operator">=</span> root<span class="token punctuation">.</span>right<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>nodeLeft<span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            nodeLeft<span class="token punctuation">.</span>next <span class="token operator">=</span> nodeRight<span class="token punctuation">;</span>            nodeLeft <span class="token operator">=</span> nodeLeft<span class="token punctuation">.</span>right<span class="token punctuation">;</span>            nodeRight <span class="token operator">=</span> nodeRight<span class="token punctuation">.</span>left<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-填充每个节点的下一个右侧节点指针-II"><a href="#4-填充每个节点的下一个右侧节点指针-II" class="headerlink" title="4. 填充每个节点的下一个右侧节点指针 II"></a>4. 填充每个节点的下一个右侧节点指针 II</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectRightNodeTwo</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 117. 填充每个节点的下一个右侧节点指针 II     */</span>    <span class="token comment">/**     * 层序遍历、队列     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">connect1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 层序遍历         * 利用队列，题目是要求二叉树的每一层的节点都连接起来形成一个链表。         * 每次出队节点的 next 指向队首的节点。         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 创建一个队列</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> deque <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点入队</span>        deque<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>deque<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 得到每一层节点的个数</span>            <span class="token keyword">int</span> size <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 一层出队，每个节点左右子节点入队。</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 从队首取出元素</span>                <span class="token class-name">TreeNode</span> node <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 将每次出对的节点都连接起来</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    node<span class="token punctuation">.</span>next <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// 出队节点的左右子节点入队</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    deque<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    deque<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 层序遍历、原地操作     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">connect2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 将每一层节点看做一个链表，然后给每一层的链表加上一个头节点，这样方便链接         * 然后循环当前一层的链表节点，将当前层节点存在的左右子树依次连接到头节点上去         */</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 当前层的开始节点</span>        <span class="token class-name">TreeNode</span> curNode <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>curNode<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">// 创建下一层的头节点</span>            <span class="token class-name">TreeNode</span> dummy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 下一层的头结点复制一份，防止头节点发生改动。</span>            <span class="token class-name">TreeNode</span> preNode <span class="token operator">=</span> dummy<span class="token punctuation">;</span>            <span class="token comment">// 开始遍历当前层的节点</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>curNode<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token comment">// 当前层节点的左子树不为空，那么接到下一层链表的后面</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    preNode<span class="token punctuation">.</span>next <span class="token operator">=</span> curNode<span class="token punctuation">.</span>left<span class="token punctuation">;</span>                    preNode <span class="token operator">=</span> preNode<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// 当前层节点的右子树不为空，那么接到下一层链表的后面</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    preNode<span class="token punctuation">.</span>next <span class="token operator">=</span> curNode<span class="token punctuation">.</span>right<span class="token punctuation">;</span>                    preNode <span class="token operator">=</span> preNode<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// 当前层节点后移一位</span>                curNode <span class="token operator">=</span> curNode<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 将下一层的头节点的下一个节点作为当前层</span>            curNode <span class="token operator">=</span> dummy<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-二叉搜索树的最近公共祖先"><a href="#5-二叉搜索树的最近公共祖先" class="headerlink" title="5. 二叉搜索树的最近公共祖先"></a>5. 二叉搜索树的最近公共祖先</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LowestCommonAncestor</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 剑指 Offer 68 - I. 二叉搜索树的最近公共祖先     */</span>    <span class="token comment">/*     * 什么是二叉搜索树？     * 每个节点中的值必须大于（或等于）存储在其左子树中的任何值；     * 每个节点中的值必须小于（或等于）存储在其右子树中的任何值；     * 根节点的值大于等于其左子树中任意一个节点的值，小于等于其右子树中任意一节点的值。     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">lowestCommonAncestor1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> p<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 两次遍历；         * 从根节点开始查找 p、q，以查找 p 为例：         * 若 root == p, 那直接返回就好；         * 若 root ！= p， 则判断 root.val 与 p.val 的大小         * 如果 root.val > p.val；说明 p 在 root 的左子树中         * 如果 root.val &lt; p.val；说明 p 在 root 的右子树中；         * 将两个节点 p、q 的路径进行对比，找到最后的相同的节点就是公共祖先了；         * 后面两个路径对比这块，感觉和 160. 相交链表 有点相似         */</span>        <span class="token comment">// 边界处理</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 得到从根节点到两个目标节点的路径</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> path_P <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> path_Q <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 定义祖先节点，初始化为根节点</span>        <span class="token class-name">TreeNode</span> ancestoNode <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token comment">// 遍历路径，找到祖先节点</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> path_P<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> path_Q<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>path_P<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> path_Q<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                ancestoNode <span class="token operator">=</span> path_P<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ancestoNode<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> <span class="token function">getPath</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点复制一份，防止根节点在后面的操作中发生改变</span>        <span class="token class-name">TreeNode</span> curNode <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>curNode <span class="token operator">!=</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 列表先添加当前节点</span>            path<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>curNode<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>val <span class="token operator">></span> target<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                curNode <span class="token operator">=</span> curNode<span class="token punctuation">.</span>left<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                curNode <span class="token operator">=</span> curNode<span class="token punctuation">.</span>right<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 当前节点 == 目标节点时，加入列表</span>        path<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>curNode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> path<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">lowestCommonAncestor2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> p<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 一次遍历。         * 从根部开始往下遍历。p 和 q 是不同的节点         * 如果 curNode.val > p与q的值，那么说明 p、q 在当前节点的左子树中，那么 curNode = curNode.left         * 如果 curNode.val &lt; p与q的值，那么说明 p、q 在当前节点的右子树中，那么 curNode = curNode.right         * 否则，p.val &lt; curNode.val &lt; q.val，则curNode为祖先节点         * 不需要考虑 p 节点是 q 节点的祖先这种情况，上面的遍历会遍历到这种情况。         */</span>        <span class="token comment">// 根节点复制一份</span>        <span class="token class-name">TreeNode</span> curNode <span class="token operator">=</span> root<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>curNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>val <span class="token operator">></span> p<span class="token punctuation">.</span>val <span class="token operator">&amp;&amp;</span> curNode<span class="token punctuation">.</span>val <span class="token operator">></span> q<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                curNode <span class="token operator">=</span> curNode<span class="token punctuation">.</span>left<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>val <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>val <span class="token operator">&amp;&amp;</span> curNode<span class="token punctuation">.</span>val <span class="token operator">&lt;</span> q<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                curNode <span class="token operator">=</span> curNode<span class="token punctuation">.</span>right<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> curNode<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 递归     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">lowestCommonAncestor3</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> p<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 与一次遍历思路一样，利用递归代替while循环         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>val <span class="token operator">></span> p<span class="token punctuation">.</span>val <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span>val <span class="token operator">></span> q<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">lowestCommonAncestor3</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>val <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>val <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span>val <span class="token operator">&lt;</span> q<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">lowestCommonAncestor3</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-二叉树的最近公共祖先"><a href="#6-二叉树的最近公共祖先" class="headerlink" title="6. 二叉树的最近公共祖先"></a>6. 二叉树的最近公共祖先</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BinaryTreeLowestCommonAncestor</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 剑指 Offer 68 - II. 二叉树的最近公共祖先     */</span>    <span class="token comment">/**     * 迭代     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">lowestCommonAncestor1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> p<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 用哈希表来存储 p、q节点的父节点，用BFS进行遍历树，只要遍历到 p、q时，就停止遍历         * 然后在获取到根节点到 p 节点的路径，然后一层一层向上找 q 的父节点，只要第一个父节点出现在根节点到 p 节点的路径中，那么返回这个节点         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> root<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 创捷一个哈希表来存储 &lt;节点, 父节点></span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">,</span> <span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> parents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">,</span> <span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点的父节点为 null</span>        parents<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 创建一个队列来 BFS</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> deque <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点入队</span>        deque<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 此时入队时不需要再用队列为空来作为终止条件了，只要当 parents 中包含 p、q 节点时，就可以中止了</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>parents<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> parents<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">TreeNode</span> curNode <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 子节点与父结点存入哈希表中</span>                parents<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left<span class="token punctuation">,</span> curNode<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 子节点入队</span>                deque<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                parents<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right<span class="token punctuation">,</span> curNode<span class="token punctuation">)</span><span class="token punctuation">;</span>                deque<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 创建一个集合来存储根节点到 p 节点的路径</span>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 循环将根节点到 p 节点经过的所有节点存入集合中</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 从 p 节点开始，并包含 p 节点，万一 p 节点是 q 节点的祖先呢！</span>            path<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            p <span class="token operator">=</span> parents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 如果 q 节点的父节点在path中没有出现，那么就在向上找父节点，如果在path中出现，那么返回这个出现的节点</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            q <span class="token operator">=</span> parents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> q<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 递归     */</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">lowestCommonAncestor2</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> p<span class="token punctuation">,</span> <span class="token class-name">TreeNode</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         *          */</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-序列化与反序列化二叉树"><a href="#7-序列化与反序列化二叉树" class="headerlink" title="7. 序列化与反序列化二叉树"></a>7. 序列化与反序列化二叉树</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeqToOppositeSeqBinaryTree</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 剑指 Offer II 048. 序列化与反序列化二叉树     */</span>    <span class="token comment">/*     * 先理解哈题     *  Codec ser = new Codec();     *  Codec deser = new Codec();     *  TreeNode ans = deser.deserialize(ser.serialize(root));     * 题目意思就是对输入的树先序列化成字符串，然后对字符串再进行解码成树，也就是说通过这两个过程，输入还要是输出。     * 树的序列化：     *      将树编码成字符串，用 "," 隔开每个节点，当前节点的子节点为空时用 "None" 来表示；     *      那就是对数进行遍历了，遍历可以分为：DFS、BFS；其中 BFS 有可以理解为树的层序遍历，DFS 包含树的 先序、中序、后序三种遍历方法；     *     *     */</span>    <span class="token comment">/* -----------------------------------------DFS：先序遍历 + 递归-----------------------------------------------*/</span>    <span class="token comment">// Encodes a tree to a single string.</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">serialize1</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 终止条件：当前节点是叶子节点时，返回"None"         * 否则当前节点的值 + "," + 再加上它的左子树的返回值 + "," + 它的右子树的返回值         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token string">"None"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">.</span>val <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> <span class="token function">serialize1</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> <span class="token function">serialize1</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Decodes your encoded data to tree.</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">deserialize1</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 将字符串切割成字符数组</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dataArray <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dataArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dataArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 将数组的元素放到队列里面去</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dataList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>dataArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">buildTree</span><span class="token punctuation">(</span>dataList<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token class-name">TreeNode</span> <span class="token function">buildTree</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dataList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 递归建立树         * 因为是前序遍历的数组，所以节点顺序为：根左右；         * 当出队的元素为空时，递归返回，并移除队首元素         * 否则就创建一个根节点，然按照先左后右的顺序将其接到递归上一层的节点上去         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            dataList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        root<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token function">buildTree</span><span class="token punctuation">(</span>dataList<span class="token punctuation">)</span><span class="token punctuation">;</span>        root<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token function">buildTree</span><span class="token punctuation">(</span>dataList<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* -----------------------------------------BFS + 迭代-----------------------------------------------*/</span>    <span class="token comment">// Encodes a tree to a single string.</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 层序遍历         * 创建一个队列，当当前节点不为null时，它的左右子树入队，不考虑他的左右子树是否为空，然后给字符串加上当前结点的值         * 若当前节点为null那么给字符串加上一个None；         */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token string">"None"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">String</span> data <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token comment">// 创建一个队列</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> deque <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根节点先入队</span>        deque<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>deque<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 获取队首元素</span>            <span class="token class-name">TreeNode</span> curNode <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>curNode<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                data <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                deque<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                deque<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                data <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token string">"None"</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 每次遍历一个节点都给后面加上一个','表间隔。</span>            data <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> data<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Decodes your encoded data to tree.</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">deserialize3</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 用队列来存储每个字符元素         * 创建一个链表来存储每层的节点，当链表遍历完时，表示这一层的节点的子节点处理完了(此处应该用队列来处理可能会更好一点)         */</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dataArray <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dataList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>dataArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> listNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 创建根节点</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 先把根节点放入链表中</span>        listNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 从listNode的第一个元素开始往后遍历</span>            <span class="token keyword">int</span> listSize <span class="token operator">=</span> listNode<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> listSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">TreeNode</span> curNode <span class="token operator">=</span> listNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    curNode<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    dataList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    listNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    curNode<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    dataList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    curNode<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    dataList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    listNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    curNode<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    dataList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">TreeNode</span> <span class="token function">deserialize4</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*         * 对deserialize3的一个优化         */</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dataArray <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span> deque <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 创建根节点</span>        <span class="token class-name">TreeNode</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>dataArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        deque<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>deque<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">TreeNode</span> curNode <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                curNode<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>dataArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                deque<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            i<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                curNode<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>dataArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                deque<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Deque.offer()：将指定元素插入此双端队列表示的队列中（换句话说，在此双端队列的尾部）。</li><li>Deque.poll()：检索并删除此双端队列表示的队列的头部（换句话说，此双端队列的第一个元素)，如果此双端队列为空，则返回null</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> 二叉树 </tag>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>blog_test</title>
      <link href="/2024/03/21/blog-test/"/>
      <url>/2024/03/21/blog-test/</url>
      
        <content type="html"><![CDATA[<h2 id="暴躁小何的博客测试"><a href="#暴躁小何的博客测试" class="headerlink" title="暴躁小何的博客测试"></a>暴躁小何的博客测试</h2> <img src="/2024/03/21/blog-test/%E5%88%98%E4%BA%A6%E8%8F%B2.jpg" class="" title="暴躁小何">    ]]></content>
      
      
      
        <tags>
            
            <tag> test </tag>
            
            <tag> Markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2024/03/20/hello-world/"/>
      <url>/2024/03/20/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! </p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> test </tag>
            
            <tag> Markdown </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
